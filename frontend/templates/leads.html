{% extends "base.html" %}

{% block title %}Leads Management - ANAGHA SOLUTION{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-users"></i> Leads Management</h1>
</div>

<div class="form-container">
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="showScraperModal()">
            <i class="fas fa-search"></i> Scrape New Leads
        </button>
        <button class="btn btn-success" onclick="showAddLeadModal()">
            <i class="fas fa-plus"></i> Add Lead Manually
        </button>
        <button class="btn btn-info" onclick="verifySelectedLeads()">
            <i class="fas fa-check-circle"></i> Verify Selected
        </button>
        <button class="btn btn-secondary" onclick="exportLeads()">
            <i class="fas fa-download"></i> Export Leads
        </button>
    </div>

    <div class="form-group">
        <input type="text" id="searchLeads" placeholder="Search by name, company, or email..." 
               style="width: 100%; padding: 10px;" onkeyup="filterLeads()">
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" id="verifiedOnly" onchange="loadLeads()">
            Show only verified leads
        </label>
    </div>

    <div id="leadsTableContainer">
        <table class="data-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Name</th>
                    <th>Company</th>
                    <th>Email</th>
                    <th>Title</th>
                    <th>Domain</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="leadsTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px;">
                        Loading leads...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" style="margin-top: 20px; text-align: center;"></div>
</div>

<!-- Lead Scraper Modal -->
<div id="scraperModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeScraperModal()">&times;</span>
        <h2>Scrape Leads from ICP</h2>
        <form id="scraperForm">
            <div class="form-group">
                <label>Lead Type *</label>
                <select id="leadType" name="lead_type" required style="width: 100%; padding: 10px; margin-bottom: 10px;">
                    <option value="B2B">B2B (Companies â†’ Decision Makers)</option>
                    <option value="B2C">B2C (Individual People)</option>
                </select>
                <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                    <strong>B2B:</strong> Find companies first, then decision makers (CEOs, VPs, Directors) in those companies<br>
                    <strong>B2C:</strong> Find individual people directly (students, engineers, freelancers, professionals)
                </small>
            </div>
            <div class="form-group">
                <label>ICP Description *</label>
                <textarea id="icpDescription" name="icp_description" rows="8" required 
                          placeholder="Describe your Ideal Customer Profile.&#10;&#10;For B2B: 'SaaS companies with 50-200 employees in the marketing technology space, based in North America...'&#10;&#10;For B2C: 'Software engineers working in tech companies, based in San Francisco, with 3-5 years experience...'"></textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Start Scraping
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeScraperModal()">Cancel</button>
            </div>
        </form>
        <div id="scraperStatus" style="margin-top: 20px;"></div>
        
        <!-- Progress Bar Section -->
        <div id="progressSection" style="display: none; margin-top: 20px;">
            <h3 style="margin-bottom: 10px;">Scraping Progress</h3>
            <div style="background: #ecf0f1; border-radius: 10px; overflow: hidden; height: 30px; position: relative;">
                <div id="progressBar" style="
                    height: 100%;
                    background: linear-gradient(90deg, #3498db, #2ecc71);
                    width: 0%;
                    transition: width 0.3s ease;
                    position: relative;
                    overflow: hidden;
                ">
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(90deg, 
                            transparent 0%, 
                            rgba(255,255,255,0.3) 50%, 
                            transparent 100%);
                        animation: shimmer 2s infinite;
                    "></div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: #7f8c8d;">
                <span id="progressPercent">0%</span>
                <span id="progressStep">Starting...</span>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="statCompanies">0</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Companies</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #2ecc71;" id="statLeads">0</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Leads Found</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="statVerified">0</div>
                        <div style="font-size: 12px; color: #7f8c8d;">Verified</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Lead Modal -->
<div id="addLeadModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeAddLeadModal()">&times;</span>
        <h2>Add Lead Manually</h2>
        <form id="addLeadForm">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Company Name *</label>
                <input type="text" name="company_name" required>
            </div>
            <div class="form-group">
                <label>Domain *</label>
                <input type="text" name="domain" required placeholder="example.com">
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" name="email" required>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" name="title" placeholder="CEO, CTO, etc.">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-success">Add Lead</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddLeadModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let allLeads = [];
let selectedLeads = [];

// Load leads on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Wait for AuthManager to be ready
    await new Promise(resolve => setTimeout(resolve, 200));
    
    // Initialize auth
    if (typeof AuthManager !== 'undefined') {
        AuthManager.init();
    }
    
    // Check authentication - validate token with backend
    if (typeof AuthManager !== 'undefined') {
        const token = AuthManager.getToken();
        if (token) {
            // Validate token with backend
            try {
                const isValid = await AuthManager.validateToken();
                if (!isValid) {
                    showAlert('Session expired. Please login again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                    return;
                }
                // Token is valid, continue loading leads
            } catch (error) {
                // Validation error - redirect to login
                showAlert('Authentication error. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
        } else {
            // No token - redirect to login
            showAlert('Please login to access leads.', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1500);
            return;
        }
    }
    
    // Load leads if authenticated
    loadLeads();
    
    // Auto-refresh leads every 5 seconds to show status updates
    setInterval(() => {
        // Only refresh if not in modal and no active job
        if (!currentJobId) {
            loadLeads();
        }
    }, 5000);
});

function loadLeads() {
    const verifiedOnly = document.getElementById('verifiedOnly').checked;
    const url = `/api/leads/list?verified_only=${verifiedOnly}`;
    
    axios.get(url)
        .then(response => {
            if (response.data.success) {
                allLeads = response.data.leads;
                displayLeads(allLeads);
            }
        })
        .catch(error => {
            console.error('Error loading leads:', error);
            showAlert('Error loading leads: ' + (error.response?.data?.error || error.message), 'error');
        });
}

function displayLeads(leads) {
    const tbody = document.getElementById('leadsTableBody');
    
    if (leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No leads found</td></tr>';
        return;
    }
    
    tbody.innerHTML = leads.map(lead => {
        const isVerified = lead.is_verified === 1;
        const statusBadge = isVerified 
            ? '<span style="color: #27ae60; font-weight: bold;"><i class="fas fa-check-circle"></i> Verified</span>'
            : '<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> Unverified</span>';
        
        // Add row ID for dynamic updates
        return `
            <tr id="lead-row-${lead.id}">
                <td><input type="checkbox" class="lead-checkbox" value="${lead.id}" onchange="updateSelectedLeads()"></td>
                <td>${lead.name || '-'}</td>
                <td>${lead.company_name || '-'}</td>
                <td>${lead.email || '-'}</td>
                <td>${lead.title || '-'}</td>
                <td>${lead.domain || '-'}</td>
                <td id="lead-status-${lead.id}">${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="verifyLead(${lead.id})" title="Verify Email" id="verify-btn-${lead.id}">
                        <i class="fas fa-check"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Update lead status dynamically
function updateLeadStatus(leadId, isVerified) {
    const statusCell = document.getElementById(`lead-status-${leadId}`);
    if (statusCell) {
        const statusBadge = isVerified 
            ? '<span style="color: #27ae60; font-weight: bold;"><i class="fas fa-check-circle"></i> Verified</span>'
            : '<span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> Unverified</span>';
        statusCell.innerHTML = statusBadge;
        
        // Add animation
        statusCell.style.transition = 'all 0.3s ease';
        statusCell.style.transform = 'scale(1.1)';
        setTimeout(() => {
            statusCell.style.transform = 'scale(1)';
        }, 300);
    }
}

function filterLeads() {
    const searchTerm = document.getElementById('searchLeads').value.toLowerCase();
    const filtered = allLeads.filter(lead => {
        const name = (lead.name || '').toLowerCase();
        const company = (lead.company_name || '').toLowerCase();
        const email = (lead.email || '').toLowerCase();
        return name.includes(searchTerm) || company.includes(searchTerm) || email.includes(searchTerm);
    });
    displayLeads(filtered);
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.lead-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedLeads();
}

function updateSelectedLeads() {
    const checkboxes = document.querySelectorAll('.lead-checkbox:checked');
    selectedLeads = Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function verifyLead(leadId) {
    const btn = document.getElementById(`verify-btn-${leadId}`);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    axios.post(`/api/leads/verify/${leadId}`)
        .then(response => {
            if (response.data.success || response.data.is_valid) {
                const isVerified = response.data.is_valid || response.data.verification_result?.is_valid || false;
                updateLeadStatus(leadId, isVerified);
                
                if (isVerified) {
                    showAlert('Lead verified successfully and added to recipients!', 'success');
                    // Reload leads to update status
                    loadLeads();
                } else {
                    showAlert('Lead verification failed: ' + (response.data.verification_result?.message || response.data.message || 'Unknown error'), 'error');
                }
                
                // Reload leads to get updated list
                loadLeads();
            } else {
                showAlert('Verification failed: ' + (response.data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            showAlert('Error verifying lead: ' + (error.response?.data?.error || error.message), 'error');
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i>';
            }
        });
}

function verifySelectedLeads() {
    if (selectedLeads.length === 0) {
        showAlert('Please select leads to verify', 'error');
        return;
    }
    
    if (!confirm(`Verify ${selectedLeads.length} selected leads? This may take a while.`)) {
        return;
    }
    
    axios.post('/api/leads/verify/batch', { lead_ids: selectedLeads })
        .then(response => {
            if (response.data.success) {
                const results = response.data.results;
                showAlert(`Verification complete: ${results.verified} verified, ${results.failed} failed`, 'success');
                loadLeads();
            }
        })
        .catch(error => {
            showAlert('Error verifying leads: ' + (error.response?.data?.error || error.message), 'error');
        });
}

function showScraperModal() {
    document.getElementById('scraperModal').style.display = 'block';
}

function closeScraperModal() {
    document.getElementById('scraperModal').style.display = 'none';
    document.getElementById('scraperForm').reset();
    document.getElementById('scraperStatus').innerHTML = '';
    document.getElementById('progressSection').style.display = 'none';
    
    // Stop progress tracking
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    currentJobId = null;
}

function showAddLeadModal() {
    document.getElementById('addLeadModal').style.display = 'block';
}

function closeAddLeadModal() {
    document.getElementById('addLeadModal').style.display = 'none';
    document.getElementById('addLeadForm').reset();
}

let currentJobId = null;
let progressInterval = null;

// Lead Scraper Form
document.getElementById('scraperForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const icpDescription = document.getElementById('icpDescription').value;
    const statusDiv = document.getElementById('scraperStatus');
    const progressSection = document.getElementById('progressSection');
    
    statusDiv.innerHTML = '<div style="color: #3498db;"><i class="fas fa-spinner fa-spin"></i> Starting scraping job...</div>';
    progressSection.style.display = 'none';
    
    const leadType = document.getElementById('leadType').value;
    axios.post('/api/leads/scrape', { 
        icp_description: icpDescription,
        lead_type: leadType
    })
        .then(response => {
            if (response.data.success) {
                // Get job ID from response
                currentJobId = response.data.job_id;
                if (currentJobId) {
                    progressSection.style.display = 'block';
                    startProgressTracking(currentJobId);
                    statusDiv.innerHTML = '<div style="color: #3498db;"><i class="fas fa-spinner fa-spin"></i> Scraping job started! Tracking progress...</div>';
                } else {
                    // Fallback: get from latest job
                    setTimeout(() => {
                        axios.get('/api/leads/scraping-jobs')
                            .then(jobsResponse => {
                                if (jobsResponse.data.success && jobsResponse.data.jobs.length > 0) {
                                    currentJobId = jobsResponse.data.jobs[0].id;
                                    progressSection.style.display = 'block';
                                    startProgressTracking(currentJobId);
                                }
                            });
                    }, 1000);
                }
            }
        })
        .catch(error => {
            statusDiv.innerHTML = '<div style="color: #e74c3c;">Error: ' + (error.response?.data?.error || error.message) + '</div>';
        });
});

// Start progress tracking
function startProgressTracking(jobId) {
    if (progressInterval) {
        clearInterval(progressInterval);
    }
    
    progressInterval = setInterval(() => {
        updateProgress(jobId);
    }, 2000); // Update every 2 seconds
    
    // Initial update
    updateProgress(jobId);
}

// Update progress bar and stats
function updateProgress(jobId) {
    axios.get(`/api/leads/scraping-job/${jobId}/status`)
        .then(response => {
            if (response.data.success) {
                const job = response.data.job;
                
                // Update progress bar
                const progressBar = document.getElementById('progressBar');
                const progressPercent = document.getElementById('progressPercent');
                const progressStep = document.getElementById('progressStep');
                
                const percent = job.progress_percent || 0;
                progressBar.style.width = percent + '%';
                progressPercent.textContent = percent + '%';
                progressStep.textContent = job.current_step || 'Processing...';
                
                // Update stats
                document.getElementById('statCompanies').textContent = job.companies_found || 0;
                document.getElementById('statLeads').textContent = job.leads_found || 0;
                document.getElementById('statVerified').textContent = job.verified_leads || 0;
                
                // Load recent leads for this job
                loadRecentLeads(jobId);
                
                // If completed, stop tracking
                if (job.status === 'completed' || job.status === 'failed') {
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    if (job.status === 'completed') {
                        progressStep.textContent = 'Completed!';
                        document.getElementById('scraperStatus').innerHTML = 
                            '<div style="color: #27ae60;"><i class="fas fa-check"></i> Scraping completed! Found ' + 
                            job.leads_found + ' leads, ' + job.verified_leads + ' verified.</div>';
                    }
                    
                    // Reload all leads
                    setTimeout(() => {
                        loadLeads();
                    }, 1000);
                }
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
}

// Load recent leads for real-time updates
function loadRecentLeads(jobId) {
    axios.get(`/api/leads/recent?job_id=${jobId}&limit=100`)
        .then(response => {
            if (response.data.success) {
                const recentLeads = response.data.leads;
                
                // Update leads table with new statuses
                recentLeads.forEach(lead => {
                    updateLeadStatus(lead.id, lead.is_verified === 1);
                });
            }
        })
        .catch(error => {
            console.error('Error loading recent leads:', error);
        });
}

// Add CSS animation for shimmer effect
const style = document.createElement('style');
style.textContent = `
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
`;
document.head.appendChild(style);

// Add Lead Form
document.getElementById('addLeadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    axios.post('/api/leads/add', data)
        .then(response => {
            if (response.data.success) {
                showAlert('Lead added successfully!', 'success');
                closeAddLeadModal();
                loadLeads();
            }
        })
        .catch(error => {
            showAlert('Error adding lead: ' + (error.response?.data?.error || error.message), 'error');
        });
});

function exportLeads() {
    const verifiedOnly = document.getElementById('verifiedOnly').checked;
    const leads = verifiedOnly ? allLeads.filter(l => l.is_verified === 1) : allLeads;
    
    // Convert to CSV
    const headers = ['Name', 'Company', 'Email', 'Title', 'Domain', 'Verified'];
    const rows = leads.map(lead => [
        lead.name || '',
        lead.company_name || '',
        lead.email || '',
        lead.title || '',
        lead.domain || '',
        lead.is_verified === 1 ? 'Yes' : 'No'
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `leads_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Close modals when clicking outside
window.onclick = function(event) {
    const scraperModal = document.getElementById('scraperModal');
    const addLeadModal = document.getElementById('addLeadModal');
    if (event.target === scraperModal) {
        closeScraperModal();
    }
    if (event.target === addLeadModal) {
        closeAddLeadModal();
    }
}
</script>
{% endblock %}

