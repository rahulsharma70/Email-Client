{% extends "base.html" %}

{% block title %}Settings - ANAGHA SOLUTION{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-cog"></i> Settings & Control Center</h1>
    <p style="color: #7f8c8d; margin-top: 5px;">Manage all application settings from one place</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
    
    <!-- Email Sending Settings -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-paper-plane" style="color: #3498db;"></i> Email Sending Settings
        </h2>
        <form id="sendingSettingsForm">
            <div class="form-group">
                <label>Time Interval Between Emails (seconds) *</label>
                <div class="radio-group" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <label class="radio-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.3s; text-align: center; justify-content: center;">
                        <input type="radio" name="interval" value="15" style="margin-right: 8px; cursor: pointer;">
                        <span style="font-size: 14px; font-weight: 500;">15 sec</span>
                    </label>
                    <label class="radio-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.3s; text-align: center; justify-content: center;">
                        <input type="radio" name="interval" value="30" style="margin-right: 8px; cursor: pointer;">
                        <span style="font-size: 14px; font-weight: 500;">30 sec</span>
                    </label>
                    <label class="radio-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.3s; text-align: center; justify-content: center;">
                        <input type="radio" name="interval" value="60" style="margin-right: 8px; cursor: pointer;">
                        <span style="font-size: 14px; font-weight: 500;">60 sec</span>
                    </label>
                </div>
                <input type="number" name="custom_interval" placeholder="Or enter custom (1-600)" min="1" max="600" style="margin-top: 10px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div class="form-group">
                <label>Max Emails Per SMTP Per Hour</label>
                <input type="number" name="max_per_hour" value="100" min="1" max="1000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Maximum number of emails each SMTP server can send per hour</small>
            </div>
            
            <div class="form-group">
                <label>Emails Per Server (Round-Robin)</label>
                <input type="number" name="emails_per_server" value="20" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Number of emails each SMTP server sends before switching</small>
            </div>
            
            <div class="form-group">
                <label>Email Queue Priority (1-10)</label>
                <input type="number" name="priority" value="5" min="1" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Higher priority emails are sent first</small>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="use_threading" id="useThreading" style="cursor: pointer;">
                    <span>Enable Multi-Thread Sending</span>
                </label>
                <small style="color: #7f8c8d; display: block; margin-top: 5px;">Send multiple emails simultaneously (use with caution)</small>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save Sending Settings
            </button>
        </form>
    </div>
    
    <!-- Email Control -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-play-circle" style="color: #27ae60;"></i> Email Sending Control
        </h2>
        <div id="emailControlPanel">
            <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-circle" id="statusIndicator" style="font-size: 12px; color: #95a5a6;"></i>
                    <span style="font-weight: bold;">Status: <span id="senderStatus">Loading...</span></span>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-danger" onclick="controlEmailSender('stop')" style="flex: 1; min-width: 100px;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button type="button" class="btn btn-warning" onclick="controlEmailSender('pause')" style="flex: 1; min-width: 100px;">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button type="button" class="btn btn-success" onclick="controlEmailSender('resume')" style="flex: 1; min-width: 100px;">
                        <i class="fas fa-play"></i> Resume
                    </button>
                </div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px;">Queue Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div>
                        <small style="color: #7f8c8d;">Pending:</small>
                        <div id="pendingCount" style="font-weight: bold; font-size: 18px;">-</div>
                    </div>
                    <div>
                        <small style="color: #7f8c8d;">Processing:</small>
                        <div id="processingCount" style="font-weight: bold; font-size: 18px;">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SMTP Server Management -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-server" style="color: #e74c3c;"></i> SMTP Server Management
        </h2>
        <div id="smtpServersList" style="max-height: 300px; overflow-y: auto;">
            <p style="color: #7f8c8d; text-align: center; padding: 20px;">Loading SMTP servers...</p>
        </div>
        <div style="margin-top: 15px;">
            <a href="/smtp-config" class="btn btn-primary" style="width: 100%; text-align: center; display: block;">
                <i class="fas fa-plus"></i> Add/Manage SMTP Servers
            </a>
        </div>
    </div>
    
    <!-- API Keys Configuration -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-key" style="color: #e67e22;"></i> API Keys Configuration
        </h2>
        <form id="apiKeysForm">
            <div class="form-group">
                <label>Perplexity API Key</label>
                <input type="password" name="perplexity_api_key" id="perplexityKey" 
                       placeholder="Enter Perplexity API key for lead scraping" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Used for lead scraping from ICP descriptions</small>
                <button type="button" class="btn btn-sm btn-secondary" onclick="togglePasswordVisibility('perplexityKey')" 
                        style="margin-top: 5px;">
                    <i class="fas fa-eye"></i> Show/Hide
                </button>
            </div>
            
            <div class="form-group">
                <label>OpenRouter API Key</label>
                <input type="password" name="openrouter_api_key" id="openrouterKey" 
                       placeholder="Enter OpenRouter API key for email personalization" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Used for AI-powered email personalization</small>
                <button type="button" class="btn btn-sm btn-secondary" onclick="togglePasswordVisibility('openrouterKey')" 
                        style="margin-top: 5px;">
                    <i class="fas fa-eye"></i> Show/Hide
                </button>
            </div>
            
            <div class="form-group">
                <label>OpenRouter Model</label>
                <select name="openrouter_model" id="openrouterModel" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="openai/gpt-4o-mini">GPT-4o Mini (Recommended - Cost Effective)</option>
                    <option value="openai/gpt-4o">GPT-4o (Higher Quality)</option>
                    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo (Fastest)</option>
                    <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                    <option value="anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
                </select>
                <small style="color: #7f8c8d;">Model to use for email personalization</small>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save API Keys
            </button>
        </form>
        <div id="apiKeysStatus" style="margin-top: 10px;"></div>
    </div>
    
    <!-- Application Settings -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-wrench" style="color: #9b59b6;"></i> Application Settings
        </h2>
        <form id="appSettingsForm">
            <div class="form-group">
                <label>Auto-Save Templates</label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="auto_save_templates" id="autoSaveTemplates" checked style="cursor: pointer;">
                    <span>Automatically save email templates while editing</span>
                </label>
            </div>
            
            <div class="form-group">
                <label>Dashboard Auto-Refresh (seconds)</label>
                <input type="number" name="dashboard_refresh" value="5" min="1" max="60" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">How often to refresh dashboard statistics</small>
            </div>
            
            <div class="form-group">
                <label>Default Campaign Status</label>
                <select name="default_campaign_status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="draft">Draft</option>
                    <option value="scheduled">Scheduled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Enable Email Tracking</label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="enable_tracking" id="enableTracking" checked style="cursor: pointer;">
                    <span>Track email opens and clicks</span>
                </label>
            </div>
            
            <div class="form-group">
                <label>Enable Unsubscribe Links</label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="enable_unsubscribe" id="enableUnsubscribe" checked style="cursor: pointer;">
                    <span>Automatically add unsubscribe links to emails</span>
                </label>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save Application Settings
            </button>
        </form>
    </div>
    
    <!-- Database & Maintenance -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-database" style="color: #f39c12;"></i> Database & Maintenance
        </h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button type="button" class="btn btn-info" onclick="exportDatabase()" style="width: 100%;">
                <i class="fas fa-download"></i> Export Database Backup
            </button>
            <button type="button" class="btn btn-warning" onclick="clearOldQueue()" style="width: 100%;">
                <i class="fas fa-trash"></i> Clear Old Queue Items
            </button>
            <button type="button" class="btn btn-danger" onclick="resetSettings()" style="width: 100%;">
                <i class="fas fa-undo"></i> Reset to Default Settings
            </button>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h4 style="margin: 0 0 10px 0; font-size: 14px;">Database Statistics</h4>
            <div id="dbStats" style="font-size: 12px; color: #7f8c8d;">
                Loading...
            </div>
        </div>
    </div>
    
    <!-- Supabase Configuration -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-cloud" style="color: #3ecf8e;"></i> Supabase Database
        </h2>
        <form id="supabaseForm">
            <div class="form-group">
                <label>Database Type</label>
                <select name="database_type" id="databaseType" onchange="toggleDatabaseType()" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="sqlite">SQLite (Local)</option>
                    <option value="supabase">Supabase (Cloud PostgreSQL)</option>
                </select>
                <small style="color: #7f8c8d;">Switch between local SQLite or cloud Supabase database</small>
            </div>
            
            <div id="supabaseConfig" style="display: none;">
                <div class="form-group">
                    <label>Supabase Project URL *</label>
                    <input type="text" name="supabase_url" id="supabaseUrl" 
                           placeholder="https://xxxxx.supabase.co" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #7f8c8d;">Your Supabase project URL from dashboard</small>
                </div>
                
                <div class="form-group">
                    <label>Supabase API Key *</label>
                    <input type="password" name="supabase_key" id="supabaseKey" 
                           placeholder="Enter Supabase anon/service key" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #7f8c8d;">Use anon key for client-side, service key for server-side</small>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="togglePasswordVisibility('supabaseKey')" 
                            style="margin-top: 5px;">
                        <i class="fas fa-eye"></i> Show/Hide
                    </button>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-info" onclick="testSupabaseConnection()" style="width: 100%;">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                </div>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save Database Configuration
            </button>
        </form>
        <div id="supabaseStatus" style="margin-top: 10px;"></div>
    </div>
    
    <!-- Deployment Settings -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-rocket" style="color: #8e44ad;"></i> Deployment Settings
        </h2>
        
        <div style="margin-bottom: 20px;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">Deployment Platform</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <button type="button" class="btn btn-primary" onclick="showDeploymentGuide('railway')" style="width: 100%;">
                    <i class="fas fa-train"></i> Railway
                </button>
                <button type="button" class="btn btn-info" onclick="showDeploymentGuide('render')" style="width: 100%;">
                    <i class="fas fa-server"></i> Render
                </button>
            </div>
        </div>
        
        <div id="deploymentGuide" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
            <h4 id="deploymentTitle" style="margin: 0 0 10px 0;"></h4>
            <div id="deploymentContent" style="font-size: 13px; line-height: 1.6;"></div>
        </div>
        
        <form id="deploymentForm">
            <div class="form-group">
                <label>Environment Variables</label>
                <textarea name="env_vars" id="envVars" rows="8" 
                          placeholder="KEY1=value1&#10;KEY2=value2&#10;..." 
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                <small style="color: #7f8c8d;">Add environment variables (one per line, KEY=value format)</small>
            </div>
            
            <div class="form-group">
                <label>Deployment URL</label>
                <input type="text" name="deployment_url" id="deploymentUrl" 
                       placeholder="https://your-app.railway.app or https://your-app.onrender.com" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Your deployed application URL</small>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save Deployment Settings
            </button>
        </form>
        <div id="deploymentStatus" style="margin-top: 10px;"></div>
    </div>
    
    <!-- Stripe Billing Configuration -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-credit-card" style="color: #635bff;"></i> Stripe Billing
        </h2>
        <form id="stripeForm">
            <div class="form-group">
                <label>Stripe Secret Key</label>
                <input type="password" name="stripe_secret_key" id="stripeSecretKey" 
                       placeholder="sk_test_..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Your Stripe secret key for payment processing</small>
                <button type="button" class="btn btn-sm btn-secondary" onclick="togglePasswordVisibility('stripeSecretKey')" 
                        style="margin-top: 5px;">
                    <i class="fas fa-eye"></i> Show/Hide
                </button>
            </div>
            
            <div class="form-group">
                <label>Stripe Publishable Key</label>
                <input type="text" name="stripe_publishable_key" id="stripePublishableKey" 
                       placeholder="pk_test_..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Your Stripe publishable key (for frontend)</small>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-info" onclick="getSubscriptionInfo()" style="width: 100%;">
                    <i class="fas fa-info-circle"></i> View Subscription Info
                </button>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save Stripe Configuration
            </button>
        </form>
        <div id="stripeStatus" style="margin-top: 10px;"></div>
        <div id="subscriptionInfo" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
            <h4 style="margin: 0 0 10px 0; font-size: 14px;">Current Subscription</h4>
            <div id="subscriptionDetails" style="font-size: 12px;"></div>
        </div>
    </div>
    
    <!-- Redis Configuration -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-database" style="color: #dc382d;"></i> Redis Configuration
        </h2>
        <form id="redisForm">
            <div class="form-group">
                <label>Redis URL</label>
                <input type="text" name="redis_url" id="redisUrl" 
                       placeholder="redis://localhost:6379/0 or redis://user:pass@host:port/db" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #7f8c8d;">Redis connection URL for Celery background workers</small>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-info" onclick="testRedisConnection()" style="width: 100%;">
                    <i class="fas fa-plug"></i> Test Redis Connection
                </button>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-save"></i> Save Redis Configuration
            </button>
        </form>
        <div id="redisStatus" style="margin-top: 10px;"></div>
    </div>
    
    <!-- Database Connection Status -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-network-wired" style="color: #16a085;"></i> Connection Status
        </h2>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="fas fa-circle" id="dbStatusIndicator" style="font-size: 12px; color: #95a5a6;"></i>
                <span style="font-weight: bold;">Database: <span id="dbStatusText">Checking...</span></span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                <div>
                    <small style="color: #7f8c8d;">Type:</small>
                    <div id="dbType" style="font-weight: bold;">-</div>
                </div>
                <div>
                    <small style="color: #7f8c8d;">Connection:</small>
                    <div id="dbConnection" style="font-weight: bold;">-</div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 11px; color: #7f8c8d;" id="dbError"></div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                <button type="button" class="btn btn-sm btn-info" onclick="checkDatabaseConnection()" style="width: 100%;">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="checkRedisStatus()" style="width: 100%;">
                    <i class="fas fa-database"></i> Check Redis
                </button>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="form-container" style="margin: 0;">
        <h2 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <i class="fas fa-bolt" style="color: #e67e22;"></i> Quick Actions
        </h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <a href="/campaign-builder" class="btn btn-primary" style="width: 100%; text-align: center; display: block;">
                <i class="fas fa-plus-circle"></i> Create New Campaign
            </a>
            <a href="/recipients" class="btn btn-info" style="width: 100%; text-align: center; display: block;">
                <i class="fas fa-users"></i> Manage Recipients
            </a>
            <a href="/templates" class="btn btn-secondary" style="width: 100%; text-align: center; display: block;">
                <i class="fas fa-file-alt"></i> Email Templates
            </a>
            <a href="/analytics" class="btn btn-success" style="width: 100%; text-align: center; display: block;">
                <i class="fas fa-chart-bar"></i> View Analytics
            </a>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadApiKeys();
    loadSmtpServers();
    loadQueueStats();
    loadDbStats();
    loadSenderStatus();
    loadDatabaseConfig();
    loadDeploymentConfig();
    loadStripeConfig();
    loadRedisConfig();
    checkDatabaseConnection();
    
    // Auto-refresh queue stats every 5 seconds
    setInterval(loadQueueStats, 5000);
    setInterval(loadSenderStatus, 3000);
    setInterval(checkDatabaseConnection, 10000); // Check DB connection every 10s
    setInterval(checkRedisStatus, 15000); // Check Redis every 15s
});

// Load API keys (masked)
async function loadApiKeys() {
    try {
        const response = await axios.get('/api/settings/api-keys');
        if (response.data.success) {
            const keys = response.data.keys;
            if (keys.perplexity_api_key) {
                document.getElementById('perplexityKey').value = keys.perplexity_api_key;
            }
            if (keys.openrouter_api_key) {
                document.getElementById('openrouterKey').value = keys.openrouter_api_key;
            }
            if (keys.openrouter_model) {
                document.getElementById('openrouterModel').value = keys.openrouter_model;
            }
        }
    } catch (error) {
        console.error('Error loading API keys:', error);
    }
}

// Save API keys
document.getElementById('apiKeysForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        perplexity_api_key: formData.get('perplexity_api_key'),
        openrouter_api_key: formData.get('openrouter_api_key'),
        openrouter_model: formData.get('openrouter_model')
    };
    
    const statusDiv = document.getElementById('apiKeysStatus');
    statusDiv.innerHTML = '<div style="color: #3498db;"><i class="fas fa-spinner fa-spin"></i> Saving...</div>';
    
    try {
        const response = await axios.post('/api/settings/api-keys', data);
        if (response.data.success) {
            statusDiv.innerHTML = '<div style="color: #27ae60;"><i class="fas fa-check"></i> API keys saved successfully!</div>';
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }
    } catch (error) {
        statusDiv.innerHTML = '<div style="color: #e74c3c;">Error: ' + (error.response?.data?.error || error.message) + '</div>';
    }
});

// Toggle password visibility
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Load all settings
async function loadSettings() {
    try {
        const response = await axios.get('/api/settings');
        if (response.data.success) {
            const settings = response.data.settings;
            
            // Set interval
            if (settings.email_delay) {
                const intervalValue = settings.email_delay.toString();
                const radio = document.querySelector(`input[name="interval"][value="${intervalValue}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                } else {
                    document.querySelector('input[name="custom_interval"]').value = intervalValue;
                }
            }
            
            // Set other values
            if (settings.max_per_hour) {
                document.querySelector('input[name="max_per_hour"]').value = settings.max_per_hour;
            }
            if (settings.email_priority) {
                document.querySelector('input[name="priority"]').value = settings.email_priority;
            }
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Save sending settings
document.getElementById('sendingSettingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const selectedInterval = document.querySelector('input[name="interval"]:checked');
    const customInterval = document.querySelector('input[name="custom_interval"]').value;
    
    const interval = customInterval && customInterval > 0 ? customInterval : (selectedInterval ? selectedInterval.value : 30);
    
    const data = {
        email_delay: parseInt(interval),
        max_per_hour: parseInt(formData.get('max_per_hour')),
        email_priority: parseInt(formData.get('priority')),
        emails_per_server: parseInt(formData.get('emails_per_server')) || 20
    };
    
    try {
        // Save delay
        await axios.post('/api/settings/delay', { email_delay: data.email_delay });
        
        // Save other settings
        await axios.post('/api/settings/other', {
            max_per_hour: data.max_per_hour,
            email_priority: data.email_priority
        });
        
        // Save emails_per_server if endpoint exists
        if (data.emails_per_server) {
            try {
                await axios.post('/api/settings/emails-per-server', { emails_per_server: data.emails_per_server });
            } catch (e) {
                // Endpoint might not exist yet
            }
        }
        
        showAlert('Sending settings saved successfully!', 'success');
    } catch (error) {
        showAlert('Error saving settings: ' + (error.response?.data?.error || error.message), 'error');
    }
});

// Load SMTP servers
async function loadSmtpServers() {
    try {
        const response = await axios.get('/api/smtp-servers');
        if (response.data.success) {
            const servers = response.data.servers;
            const container = document.getElementById('smtpServersList');
            
            if (servers.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No SMTP servers configured</p>';
                return;
            }
            
            container.innerHTML = servers.slice(0, 5).map(server => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${server.name || server.username}</strong><br>
                        <small style="color: #7f8c8d;">${server.username}</small>
                    </div>
                    <span style="color: ${server.is_active ? '#27ae60' : '#e74c3c'}; font-size: 12px;">
                        ${server.is_active ? '✓ Active' : '✗ Inactive'}
                    </span>
                </div>
            `).join('');
            
            if (servers.length > 5) {
                container.innerHTML += `<p style="text-align: center; padding: 10px; color: #7f8c8d;">+ ${servers.length - 5} more servers</p>`;
            }
        }
    } catch (error) {
        console.error('Error loading SMTP servers:', error);
    }
}

// Load queue statistics
async function loadQueueStats() {
    try {
        const response = await axios.get('/api/dashboard/stats');
        if (response.data.success) {
            const stats = response.data.stats;
            document.getElementById('pendingCount').textContent = stats.pending_queue || 0;
            document.getElementById('processingCount').textContent = stats.processing_queue || 0;
        }
    } catch (error) {
        console.error('Error loading queue stats:', error);
    }
}

// Load database statistics
async function loadDbStats() {
    try {
        const response = await axios.get('/api/dashboard/stats');
        if (response.data.success) {
            const stats = response.data.stats;
            document.getElementById('dbStats').innerHTML = `
                <div>Campaigns: ${stats.total_campaigns || 0}</div>
                <div>Recipients: ${stats.total_recipients || 0}</div>
                <div>Templates: ${stats.total_templates || 0}</div>
                <div>SMTP Servers: ${stats.total_smtp_servers || 0}</div>
            `;
        }
    } catch (error) {
        console.error('Error loading DB stats:', error);
    }
}

// Load sender status
async function loadSenderStatus() {
    try {
        const response = await axios.get('/api/email-sender/status');
        if (response.data.success) {
            const status = response.data.status;
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);
            document.getElementById('senderStatus').textContent = statusText;
            
            const indicator = document.getElementById('statusIndicator');
            if (status === 'sending') {
                indicator.style.color = '#27ae60';
            } else if (status === 'paused') {
                indicator.style.color = '#f39c12';
            } else {
                indicator.style.color = '#e74c3c';
            }
        }
    } catch (error) {
        console.error('Error loading sender status:', error);
    }
}

// Control email sender
async function controlEmailSender(action) {
    try {
        const response = await axios.post(`/api/email-sender/${action}`);
        if (response.data.success) {
            showAlert(`Email sending ${action}ed successfully!`, 'success');
            loadSenderStatus();
        }
    } catch (error) {
        showAlert(`Error ${action}ing email sender: ${error.response?.data?.error || error.message}`, 'error');
    }
}

// Radio button visual feedback
document.querySelectorAll('input[name="interval"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.radio-option').forEach(option => {
            option.style.borderColor = '#ddd';
            option.style.backgroundColor = 'transparent';
        });
        if (this.checked) {
            this.closest('.radio-option').style.borderColor = '#667eea';
            this.closest('.radio-option').style.backgroundColor = '#f0f4ff';
        }
        document.querySelector('input[name="custom_interval"]').value = '';
    });
});

// Application settings form
document.getElementById('appSettingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    showAlert('Application settings saved!', 'success');
});

// Quick action functions
function exportDatabase() {
    showAlert('Database export feature coming soon!', 'info');
}

function clearOldQueue() {
    if (confirm('Are you sure you want to clear old queue items? This cannot be undone.')) {
        showAlert('Clearing old queue items...', 'info');
    }
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to default? This cannot be undone.')) {
        showAlert('Resetting settings...', 'info');
    }
}

// Database Configuration Functions
function toggleDatabaseType() {
    const dbType = document.getElementById('databaseType').value;
    const supabaseConfig = document.getElementById('supabaseConfig');
    supabaseConfig.style.display = dbType === 'supabase' ? 'block' : 'none';
}

async function loadDatabaseConfig() {
    try {
        const response = await axios.get('/api/settings/database');
        if (response.data.success) {
            const config = response.data.config;
            document.getElementById('databaseType').value = config.database_type || 'sqlite';
            if (config.supabase_url) {
                document.getElementById('supabaseUrl').value = config.supabase_url;
            }
            if (config.supabase_key) {
                document.getElementById('supabaseKey').value = config.supabase_key;
            }
            toggleDatabaseType();
        }
    } catch (error) {
        console.error('Error loading database config:', error);
    }
}

document.getElementById('supabaseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = {
        database_type: document.getElementById('databaseType').value,
        supabase_url: document.getElementById('supabaseUrl').value,
        supabase_key: document.getElementById('supabaseKey').value
    };
    
    try {
        const response = await axios.post('/api/settings/database', formData);
        if (response.data.success) {
            showAlert('Database configuration saved successfully!', 'success');
            checkDatabaseConnection();
        } else {
            showAlert('Error: ' + (response.data.error || 'Failed to save'), 'error');
        }
    } catch (error) {
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
    }
});

async function testSupabaseConnection() {
    const url = document.getElementById('supabaseUrl').value;
    const key = document.getElementById('supabaseKey').value;
    
    if (!url || !key) {
        showAlert('Please enter Supabase URL and Key', 'error');
        return;
    }
    
    try {
        const response = await axios.post('/api/settings/test-supabase', { url, key });
        if (response.data.success) {
            showAlert('✓ Supabase connection successful!', 'success');
        } else {
            showAlert('✗ Connection failed: ' + (response.data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('✗ Connection failed: ' + (error.response?.data?.error || error.message), 'error');
    }
}

async function checkDatabaseConnection() {
    try {
        const response = await axios.get('/api/settings/database-status');
        if (response.data.success) {
            const status = response.data.status;
            const indicator = document.getElementById('dbStatusIndicator');
            const statusText = document.getElementById('dbStatusText');
            const dbType = document.getElementById('dbType');
            const dbConnection = document.getElementById('dbConnection');
            
            if (status.connected) {
                indicator.style.color = '#27ae60';
                statusText.textContent = 'Connected';
                dbType.textContent = status.database_type || 'SQLite';
                dbConnection.textContent = 'Active';
            } else {
                indicator.style.color = '#e74c3c';
                statusText.textContent = 'Disconnected';
                dbType.textContent = status.database_type || 'Unknown';
                dbConnection.textContent = 'Failed';
            }
        }
    } catch (error) {
        console.error('Error checking database status:', error);
    }
}

// Deployment Functions
function showDeploymentGuide(platform) {
    const guide = document.getElementById('deploymentGuide');
    const title = document.getElementById('deploymentTitle');
    const content = document.getElementById('deploymentContent');
    
    guide.style.display = 'block';
    
    if (platform === 'railway') {
        title.textContent = 'Railway Deployment Guide';
        content.innerHTML = `
            <ol style="margin: 0; padding-left: 20px;">
                <li>Install Railway CLI: <code>npm i -g @railway/cli</code></li>
                <li>Login: <code>railway login</code></li>
                <li>Create new project: <code>railway init</code></li>
                <li>Add environment variables in Railway dashboard</li>
                <li>Deploy: <code>railway up</code> or connect GitHub repo</li>
                <li>Set custom domain (optional)</li>
            </ol>
            <p style="margin-top: 10px;"><strong>Required Environment Variables:</strong></p>
            <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                <li>SUPABASE_URL</li>
                <li>SUPABASE_KEY</li>
                <li>JWT_SECRET_KEY</li>
                <li>STRIPE_SECRET_KEY</li>
                <li>REDIS_URL</li>
                <li>PERPLEXITY_API_KEY</li>
                <li>OPENROUTER_API_KEY</li>
            </ul>
        `;
    } else if (platform === 'render') {
        title.textContent = 'Render Deployment Guide';
        content.innerHTML = `
            <ol style="margin: 0; padding-left: 20px;">
                <li>Go to <a href="https://render.com" target="_blank">render.com</a></li>
                <li>Create new Web Service</li>
                <li>Connect your GitHub repository</li>
                <li>Set build command: <code>pip install -r requirements.txt</code></li>
                <li>Set start command: <code>gunicorn --bind 0.0.0.0:$PORT web_app:app</code></li>
                <li>Add environment variables in Render dashboard</li>
                <li>Deploy and wait for build to complete</li>
            </ol>
            <p style="margin-top: 10px;"><strong>Required Environment Variables:</strong></p>
            <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                <li>SUPABASE_URL</li>
                <li>SUPABASE_KEY</li>
                <li>JWT_SECRET_KEY</li>
                <li>STRIPE_SECRET_KEY</li>
                <li>REDIS_URL</li>
                <li>PERPLEXITY_API_KEY</li>
                <li>OPENROUTER_API_KEY</li>
            </ul>
        `;
    }
}

async function loadDeploymentConfig() {
    try {
        const response = await axios.get('/api/settings/deployment');
        if (response.data.success) {
            const config = response.data.config;
            if (config.env_vars) {
                document.getElementById('envVars').value = config.env_vars;
            }
            if (config.deployment_url) {
                document.getElementById('deploymentUrl').value = config.deployment_url;
            }
        }
    } catch (error) {
        console.error('Error loading deployment config:', error);
    }
}

document.getElementById('deploymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = {
        env_vars: document.getElementById('envVars').value,
        deployment_url: document.getElementById('deploymentUrl').value
    };
    
    try {
        const response = await axios.post('/api/settings/deployment', formData);
        if (response.data.success) {
            showAlert('Deployment settings saved successfully!', 'success');
        } else {
            showAlert('Error: ' + (response.data.error || 'Failed to save'), 'error');
        }
    } catch (error) {
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
    }
});

// Stripe Configuration Functions
async function loadStripeConfig() {
    try {
        const response = await axios.get('/api/settings/stripe');
        if (response.data.success) {
            const config = response.data.config;
            if (config.stripe_secret_key) {
                document.getElementById('stripeSecretKey').value = config.stripe_secret_key;
            }
            if (config.stripe_publishable_key) {
                document.getElementById('stripePublishableKey').value = config.stripe_publishable_key;
            }
        }
    } catch (error) {
        console.error('Error loading Stripe config:', error);
    }
}

document.getElementById('stripeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = {
        stripe_secret_key: document.getElementById('stripeSecretKey').value,
        stripe_publishable_key: document.getElementById('stripePublishableKey').value
    };
    
    try {
        const response = await axios.post('/api/settings/stripe', formData);
        if (response.data.success) {
            showAlert('Stripe configuration saved successfully!', 'success');
        } else {
            showAlert('Error: ' + (response.data.error || 'Failed to save'), 'error');
        }
    } catch (error) {
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
    }
});

async function getSubscriptionInfo() {
    try {
        const response = await axios.get('/api/settings/subscription-info');
        if (response.data.success) {
            const subscription = response.data.subscription;
            const infoDiv = document.getElementById('subscriptionInfo');
            const detailsDiv = document.getElementById('subscriptionDetails');
            
            infoDiv.style.display = 'block';
            detailsDiv.innerHTML = `
                <div><strong>Plan:</strong> ${subscription.plan_name || subscription.plan}</div>
                <div><strong>Status:</strong> ${subscription.status}</div>
                <div><strong>Emails/Month:</strong> ${subscription.emails_per_month || 'Unlimited'}</div>
                <div><strong>Features:</strong> ${subscription.features?.join(', ') || 'None'}</div>
            `;
        } else {
            showAlert('No active subscription found', 'info');
        }
    } catch (error) {
        if (error.response?.status === 401) {
            showAlert('Please login to view subscription info', 'error');
        } else {
            showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
        }
    }
}

// Redis Configuration Functions
async function loadRedisConfig() {
    try {
        const response = await axios.get('/api/settings/redis');
        if (response.data.success) {
            const config = response.data.config;
            if (config.redis_url) {
                document.getElementById('redisUrl').value = config.redis_url;
            }
        }
    } catch (error) {
        console.error('Error loading Redis config:', error);
    }
}

document.getElementById('redisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = {
        redis_url: document.getElementById('redisUrl').value
    };
    
    try {
        const response = await axios.post('/api/settings/redis', formData);
        if (response.data.success) {
            showAlert('Redis configuration saved successfully!', 'success');
        } else {
            showAlert('Error: ' + (response.data.error || 'Failed to save'), 'error');
        }
    } catch (error) {
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
    }
});

async function testRedisConnection() {
    const redisUrl = document.getElementById('redisUrl').value;
    
    if (!redisUrl) {
        showAlert('Please enter Redis URL', 'error');
        return;
    }
    
    try {
        const response = await axios.post('/api/settings/test-redis', { redis_url: redisUrl });
        if (response.data.success) {
            showAlert('✓ Redis connection successful!', 'success');
        } else {
            showAlert('✗ Connection failed: ' + (response.data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('✗ Connection failed: ' + (error.response?.data?.error || error.message), 'error');
    }
}
</script>
{% endblock %}
