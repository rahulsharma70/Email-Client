{% extends "base.html" %}

{% block title %}Inbox - ANAGHA SOLUTION{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-inbox"></i> Inbox</h1>
</div>

<!-- Hot Leads and Follow-ups Section -->
<div class="form-container" style="margin-bottom: 20px;">
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button class="btn btn-success" onclick="showHotLeads()">
            <i class="fas fa-fire"></i> Hot Leads
            <span id="hotLeadsCount" class="badge">0</span>
        </button>
        <button class="btn btn-warning" onclick="showFollowUps()">
            <i class="fas fa-clock"></i> Follow-ups Needed
            <span id="followUpsCount" class="badge">0</span>
        </button>
        <button class="btn btn-info" onclick="monitorInbox()">
            <i class="fas fa-sync"></i> Monitor Inbox
        </button>
    </div>
    
    <div id="hotLeadsSection" style="display: none;">
        <h3><i class="fas fa-fire"></i> Hot Leads</h3>
        <div id="hotLeadsList" style="margin-top: 10px;">
            <p>Loading hot leads...</p>
        </div>
    </div>
    
    <div id="followUpsSection" style="display: none;">
        <h3><i class="fas fa-clock"></i> Follow-ups Needed</h3>
        <div id="followUpsList" style="margin-top: 10px;">
            <p>Loading follow-ups...</p>
        </div>
    </div>
</div>

<!-- Add/Edit Email Account Section -->
<div class="form-container" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="formTitle"><i class="fas fa-plus-circle"></i> Add / Configure Email Account</h2>
        <button class="btn btn-secondary" onclick="toggleAccountForm()" id="toggleFormBtn">
            <i class="fas fa-chevron-down"></i> Show Form
        </button>
    </div>
    
    <div id="accountFormSection" style="display: none;">
        <form id="emailAccountForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Left Column - Outgoing (SMTP) -->
                <div class="settings-section">
                    <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-paper-plane"></i> Outgoing Mail (SMTP)</h3>
                    
                    <div class="form-group">
                        <label>Account Name *</label>
                        <input type="text" name="name" id="accountName" placeholder="My Email Account" required>
                    </div>
                    
                    <div class="form-group">
                        <label>SMTP Host *</label>
                        <input type="text" name="smtp_host" id="smtpHost" placeholder="smtp.gmail.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label>SMTP Port *</label>
                        <input type="number" name="smtp_port" id="smtpPort" value="465" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" name="username" id="emailUsername" placeholder="your@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" name="password" id="emailPassword" placeholder="Your email password" required>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" name="smtp_ssl" id="smtpSSL" checked> Use SSL (Port 465)
                        </label>
                        <label>
                            <input type="checkbox" name="smtp_tls" id="smtpTLS"> Use TLS (Port 587)
                        </label>
                    </div>
                    
                    <button type="button" class="btn btn-info" onclick="testSMTPConnection()">
                        <i class="fas fa-plug"></i> Test SMTP
                    </button>
                </div>
                
                <!-- Right Column - Incoming Mail Settings -->
                <div class="settings-section">
                    <h3 style="color: #27ae60; margin-bottom: 15px;"><i class="fas fa-inbox"></i> Incoming Mail Server</h3>
                    
                    <!-- Protocol Selection -->
                    <div class="form-group">
                        <label>Protocol Type *</label>
                        <div class="protocol-selector">
                            <label class="protocol-option">
                                <input type="radio" name="incoming_protocol" value="imap" checked onchange="switchProtocol('imap')">
                                <span class="protocol-label">
                                    <i class="fas fa-sync-alt"></i> IMAP
                                    <small>Sync emails across devices</small>
                                </span>
                            </label>
                            <label class="protocol-option">
                                <input type="radio" name="incoming_protocol" value="pop3" onchange="switchProtocol('pop3')">
                                <span class="protocol-label">
                                    <i class="fas fa-download"></i> POP3
                                    <small>Download to single device</small>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- IMAP Settings -->
                    <div id="imapSettings">
                        <div class="form-group">
                            <label>IMAP Host *</label>
                            <input type="text" name="imap_host" id="imapHost" placeholder="imap.gmail.com">
                        </div>
                        
                        <div class="form-group">
                            <label>IMAP Port *</label>
                            <input type="number" name="imap_port" id="imapPort" value="993">
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" name="imap_ssl" id="imapSSL" checked> Use SSL (Port 993)
                            </label>
                            <label>
                                <input type="checkbox" name="imap_tls" id="imapTLS"> Use TLS (Port 143)
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-info" onclick="testIMAPConnection()">
                            <i class="fas fa-plug"></i> Test IMAP
                        </button>
                    </div>
                    
                    <!-- POP3 Settings -->
                    <div id="pop3Settings" style="display: none;">
                        <div class="form-group">
                            <label>POP3 Host *</label>
                            <input type="text" name="pop3_host" id="pop3Host" placeholder="pop.gmail.com">
                        </div>
                        
                        <div class="form-group">
                            <label>POP3 Port *</label>
                            <input type="number" name="pop3_port" id="pop3Port" value="995">
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" name="pop3_ssl" id="pop3SSL" checked> Use SSL (Port 995)
                            </label>
                            <label>
                                <input type="checkbox" name="pop3_tls" id="pop3TLS"> Use TLS (Port 110)
                            </label>
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" name="pop3_leave_on_server" id="pop3LeaveOnServer" checked> Leave messages on server
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-info" onclick="testPOP3Connection()">
                            <i class="fas fa-plug"></i> Test POP3
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 10px; background: #2a2a40; border-radius: 8px;">
                        <h4 style="color: #f39c12; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Common Settings</h4>
                        <table style="font-size: 11px; color: #888; width: 100%;">
                            <tr><td colspan="2" style="color: #667eea; padding-top: 5px;"><strong>IMAP:</strong></td></tr>
                            <tr><td>Gmail:</td><td>imap.gmail.com:993</td></tr>
                            <tr><td>Outlook:</td><td>outlook.office365.com:993</td></tr>
                            <tr><td>Yahoo:</td><td>imap.mail.yahoo.com:993</td></tr>
                            <tr><td>GoDaddy:</td><td>imap.secureserver.net:993</td></tr>
                            <tr><td colspan="2" style="color: #e74c3c; padding-top: 10px;"><strong>POP3:</strong></td></tr>
                            <tr><td>Gmail:</td><td>pop.gmail.com:995</td></tr>
                            <tr><td>Outlook:</td><td>outlook.office365.com:995</td></tr>
                            <tr><td>Yahoo:</td><td>pop.mail.yahoo.com:995</td></tr>
                            <tr><td>GoDaddy:</td><td>pop.secureserver.net:995</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Save Email Account
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearAccountForm()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Email Account Selector -->
<div class="form-container" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0;"><i class="fas fa-envelope"></i> Select Email Account</h2>
        <div id="currentAccountInfo" style="display: none; padding: 8px 15px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; color: white; font-size: 14px;">
            <i class="fas fa-check-circle"></i> <span id="currentAccountName">No account selected</span>
        </div>
    </div>
    <div class="account-selector">
        <div id="accountsList" class="radio-group-horizontal">
            <p style="color: #888;">Loading email accounts...</p>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="fetchEmails()" id="fetchBtn">
                <i class="fas fa-sync"></i> Refresh Emails
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedEmails()" id="deleteBtn" disabled>
                <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
            </button>
            <button class="btn btn-secondary" onclick="selectAllEmails()">
                <i class="fas fa-check-double"></i> Select All
            </button>
            <button class="btn btn-secondary" onclick="deselectAllEmails()">
                <i class="fas fa-times"></i> Deselect All
            </button>
        </div>
    </div>
</div>

<!-- Account Folders Section -->
<div class="account-folders-container" id="accountFoldersContainer" style="display: none;">
    <h3 style="color: #667eea; margin-bottom: 15px;"><i class="fas fa-folder"></i> Email Account Folders</h3>
    <div id="accountFoldersList" class="account-folders-list">
        <!-- Account folders will be dynamically generated here -->
    </div>
</div>

<!-- Folder Tabs and Sort Controls -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
    <div class="folder-tabs">
        <button class="folder-tab active" data-folder="INBOX" onclick="selectFolder('INBOX')">
            <i class="fas fa-inbox"></i> Inbox
        </button>
        <button class="folder-tab" data-folder="Sent" onclick="selectFolder('Sent')">
            <i class="fas fa-paper-plane"></i> Sent
        </button>
        <button class="folder-tab" data-folder="Drafts" onclick="selectFolder('Drafts')">
            <i class="fas fa-file-alt"></i> Drafts
        </button>
        <button class="folder-tab" data-folder="Trash" onclick="selectFolder('Trash')">
            <i class="fas fa-trash"></i> Trash
        </button>
        <button class="folder-tab" data-folder="Spam" onclick="selectFolder('Spam')">
            <i class="fas fa-ban"></i> Spam
        </button>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
        <label style="font-weight: 500; color: #667eea;">Sort by Date:</label>
        <select id="sortOrder" onchange="applySorting()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
            <option value="desc">Newest First (Descending)</option>
            <option value="asc">Oldest First (Ascending)</option>
        </select>
    </div>
</div>

<!-- Split Panel Email View -->
<div class="email-split-container">
    <!-- Left Panel - Email List -->
    <div class="email-list-panel">
        <div id="loadingIndicator" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea;"></i>
            <p style="margin-top: 15px; color: #888;">Fetching emails...</p>
        </div>
        
        <div id="emailsList" class="emails-list">
            <div id="noEmailsMessage" class="no-emails-message">
                <i class="fas fa-envelope-open fa-3x"></i>
                <p>No emails found</p>
                <small>Add an email account, select it, and click "Fetch Emails"</small>
            </div>
        </div>
    </div>
    
    <!-- Right Panel - Email Preview -->
    <div class="email-preview-panel" id="emailPreviewPanel">
        <div id="noPreviewMessage" class="no-preview-message">
            <i class="fas fa-envelope fa-4x"></i>
            <p>Select an email to preview</p>
        </div>
        
        <div id="emailPreview" class="email-preview" style="display: none;">
            <div class="preview-header">
                <div class="preview-subject" id="previewSubject">Email Subject</div>
                <div class="preview-actions">
                    <button class="btn btn-danger btn-sm" onclick="deleteCurrentEmail()" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="openInModal()" title="Full Screen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="preview-meta">
                <div class="preview-from">
                    <span class="meta-label">From:</span>
                    <span id="previewFrom"></span>
                </div>
                <div class="preview-to">
                    <span class="meta-label">To:</span>
                    <span id="previewTo"></span>
                </div>
                <div class="preview-date">
                    <span class="meta-label">Date:</span>
                    <span id="previewDate"></span>
                </div>
            </div>
            <div class="preview-body" id="previewBody"></div>
        </div>
    </div>
</div>

<!-- Email Full View Modal (for expanded view) -->
<div id="emailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalSubject">Email Subject</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="email-meta">
                <p><strong>From:</strong> <span id="modalFrom"></span></p>
                <p><strong>To:</strong> <span id="modalTo"></span></p>
                <p><strong>Date:</strong> <span id="modalDate"></span></p>
            </div>
            <hr>
            <div id="modalBody" class="email-body"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="deleteEmailFromModal()">
                <i class="fas fa-trash"></i> Delete
            </button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<style>
/* Split Panel Layout */
.email-split-container {
    display: flex;
    gap: 20px;
    height: calc(100vh - 500px);
    min-height: 400px;
    background: #1e1e2e;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #3a3a50;
}

.email-list-panel {
    width: 45%;
    min-width: 350px;
    border-right: 1px solid #3a3a50;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.email-preview-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #252535;
}

.emails-list {
    flex: 1;
    overflow-y: auto;
}

.email-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #3a3a50;
    cursor: pointer;
    transition: all 0.2s ease;
}

.email-item:hover {
    background: rgba(102, 126, 234, 0.1);
}

.email-item.selected {
    background: rgba(102, 126, 234, 0.2);
    border-left: 3px solid #667eea;
}

.email-item.unread {
    background: rgba(102, 126, 234, 0.05);
}

.email-item.unread .email-item-subject {
    font-weight: 700;
    color: #fff;
}

.email-item-checkbox {
    margin-right: 12px;
}

.email-item-checkbox input {
    width: 18px;
    height: 18px;
    accent-color: #667eea;
    cursor: pointer;
}

.email-item-content {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.email-item-from {
    font-size: 13px;
    color: #667eea;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.email-item-subject {
    font-size: 14px;
    color: #ccc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
}

.email-item-preview {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.email-item-date {
    font-size: 11px;
    color: #888;
    margin-left: 10px;
    white-space: nowrap;
}

.email-item-delete {
    opacity: 0;
    margin-left: 10px;
    padding: 5px 8px;
    background: #e74c3c;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    transition: opacity 0.2s;
}

.email-item:hover .email-item-delete {
    opacity: 1;
}

.no-emails-message, .no-preview-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #555;
    text-align: center;
    padding: 40px;
}

.no-emails-message i, .no-preview-message i {
    margin-bottom: 15px;
    opacity: 0.5;
}

.no-emails-message p, .no-preview-message p {
    font-size: 16px;
    color: #888;
    margin-bottom: 5px;
}

.no-emails-message small, .no-preview-message small {
    color: #666;
    font-size: 12px;
}

/* Email Preview Panel */
.email-preview {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.preview-subject {
    font-size: 18px;
    font-weight: 600;
    flex: 1;
    margin-right: 15px;
    word-break: break-word;
}

.preview-actions {
    display: flex;
    gap: 8px;
}

.preview-meta {
    padding: 15px 20px;
    background: #2a2a40;
    border-bottom: 1px solid #3a3a50;
    font-size: 13px;
}

.preview-meta > div {
    margin-bottom: 5px;
}

.preview-meta > div:last-child {
    margin-bottom: 0;
}

.meta-label {
    color: #888;
    margin-right: 8px;
    font-weight: 500;
}

.preview-meta span:not(.meta-label) {
    color: #ccc;
}

.preview-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #1e1e2e;
    color: #ddd;
    line-height: 1.6;
}

.preview-body img {
    max-width: 100%;
    height: auto;
}

.settings-section {
    background: #2a2a40;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #3a3a50;
}

.protocol-selector {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.protocol-option {
    display: flex;
    align-items: center;
    padding: 12px 18px;
    background: #1e1e2e;
    border: 2px solid #3a3a50;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1;
}

.protocol-option:hover {
    border-color: #667eea;
}

.protocol-option:has(input:checked) {
    border-color: #27ae60;
    background: rgba(39, 174, 96, 0.1);
}

.protocol-option input[type="radio"] {
    width: 18px;
    height: 18px;
    margin-right: 10px;
    accent-color: #27ae60;
}

.protocol-label {
    display: flex;
    flex-direction: column;
}

.protocol-label i {
    margin-bottom: 3px;
    color: #667eea;
}

.protocol-label small {
    font-size: 10px;
    color: #888;
}

.checkbox-group {
    display: flex;
    gap: 20px;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #667eea;
}

.account-selector {
    padding: 10px 0;
}

.radio-group-horizontal {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.account-option {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    background: #2a2a40;
    border: 2px solid #3a3a50;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 200px;
}

.account-option:hover {
    border-color: #667eea;
}

.account-option.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
}

.account-option input[type="radio"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    accent-color: #667eea;
}

.account-info {
    display: flex;
    flex-direction: column;
}

.account-name {
    font-weight: 600;
    color: #fff;
}

.account-email {
    font-size: 12px;
    color: #888;
}

.account-status {
    font-size: 10px;
    margin-top: 3px;
}

.account-status.configured {
    color: #27ae60;
}

.account-status.not-configured {
    color: #e74c3c;
}

.account-folders-container {
    background: #2a2a40;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #3a3a50;
}

.account-folders-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.account-folder {
    background: #1e1e2e;
    border: 2px solid #3a3a50;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.account-folder:hover {
    border-color: #667eea;
    background: #252535;
}

.account-folder.active {
    border-color: #667eea;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
}

.account-folder-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.account-folder-icon {
    font-size: 24px;
    color: #667eea;
}

.account-folder-name {
    font-weight: 600;
    color: #fff;
    flex: 1;
}

.account-folder-email {
    font-size: 12px;
    color: #888;
    margin-bottom: 8px;
}

.account-folder-stats {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
}

.account-folder-count {
    color: #667eea;
    font-weight: 600;
}

.folder-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.folder-tab {
    padding: 10px 20px;
    background: #2a2a40;
    border: 2px solid #3a3a50;
    border-radius: 8px;
    color: #888;
    cursor: pointer;
    transition: all 0.3s ease;
}

.folder-tab:hover {
    border-color: #667eea;
    color: #fff;
}

.folder-tab.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    color: #fff;
}

#emailsTable {
    width: 100%;
}

#emailsTable tbody tr {
    cursor: pointer;
    transition: background 0.2s;
}

#emailsTable tbody tr:hover {
    background: rgba(102, 126, 234, 0.1);
}

#emailsTable tbody tr.selected {
    background: rgba(102, 126, 234, 0.2);
}

#emailsTable tbody tr.unread {
    font-weight: bold;
}

#emailsTable tbody tr.unread td {
    color: #fff;
}

#emailsTable input[type="radio"],
#emailsTable input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #667eea;
    cursor: pointer;
}

.email-subject {
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: #1e1e2e;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
    color: #fff;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 90%;
}

.modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 28px;
    cursor: pointer;
    padding: 0 10px;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.email-meta {
    color: #888;
    font-size: 14px;
}

.email-meta p {
    margin: 5px 0;
}

.email-body {
    margin-top: 15px;
    color: #ccc;
    line-height: 1.6;
}

.email-body img {
    max-width: 100%;
    height: auto;
}

.modal-footer {
    padding: 15px 20px;
    background: #2a2a40;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 12px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedAccountId = null;
let selectedFolder = 'INBOX';
let sortOrder = 'desc'; // 'desc' for newest first, 'asc' for oldest first
let currentEmails = [];
let currentEmailId = null;
let accountsData = [];
let emailsByAccount = {}; // Store emails organized by account ID
let autoFetchEnabled = true; // Auto-fetch emails when account is selected

// Load accounts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
});

function toggleAccountForm() {
    const section = document.getElementById('accountFormSection');
    const btn = document.getElementById('toggleFormBtn');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Form';
    } else {
        section.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-chevron-down"></i> Show Form';
    }
}

async function loadAccounts() {
    try {
        const response = await axios.get('/api/smtp/list');
        accountsData = response.data.servers || [];
        const container = document.getElementById('accountsList');
        
        if (accountsData.length === 0) {
            container.innerHTML = `
                <div style="color: #f39c12; padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 8px;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    No email accounts configured. Click "Show Form" above to add one.
                </div>
            `;
            // Show the form automatically
            document.getElementById('accountFormSection').style.display = 'block';
            document.getElementById('toggleFormBtn').innerHTML = '<i class="fas fa-chevron-up"></i> Hide Form';
            return;
        }
        
        container.innerHTML = accountsData.map((server, index) => {
            const hasIMAP = server.imap_host && server.imap_host.trim() !== '';
            const hasPOP3 = server.pop3_host && server.pop3_host.trim() !== '';
            const hasIncoming = hasIMAP || hasPOP3;
            let statusText = '';
            if (hasIMAP) statusText = 'âœ“ IMAP Configured';
            else if (hasPOP3) statusText = 'âœ“ POP3 Configured';
            else statusText = 'âœ— Not Configured - Click to setup';
            
            return `
                <label class="account-option ${index === 0 ? 'selected' : ''}" data-id="${server.id}" onclick="selectAccount(${server.id})">
                    <input type="radio" name="account" value="${server.id}" ${index === 0 ? 'checked' : ''}>
                    <div class="account-info">
                        <span class="account-name">${server.name}</span>
                        <span class="account-email">${server.username}</span>
                        <span class="account-status ${hasIncoming ? 'configured' : 'not-configured'}">
                            ${statusText}
                        </span>
                    </div>
                </label>
            `;
        }).join('');
        
        // Select first account by default and auto-fetch
        if (accountsData.length > 0) {
            const firstAccount = accountsData[0];
            selectedAccountId = firstAccount.id;
            
            // Update radio button selection
            const firstRadio = document.querySelector(`input[name="account"][value="${firstAccount.id}"]`);
            if (firstRadio) {
                firstRadio.checked = true;
            }
            
            // Update visual selection
            document.querySelectorAll('.account-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.id == firstAccount.id) {
                    el.classList.add('selected');
                }
            });
            
            // Update current account info
            document.getElementById('currentAccountInfo').style.display = 'block';
            document.getElementById('currentAccountName').textContent = `${firstAccount.name} (${firstAccount.username})`;
            
            // Create account folders
            createAccountFolders();
            
            // Auto-fetch emails for first account if configured
            const hasIMAP = firstAccount.imap_host && firstAccount.imap_host.trim() !== '';
            const hasPOP3 = firstAccount.pop3_host && firstAccount.pop3_host.trim() !== '';
            if (autoFetchEnabled && (hasIMAP || hasPOP3)) {
                setTimeout(() => {
                    showAlert(`ðŸ”„ Auto-fetching emails for ${firstAccount.name}...`, 'info');
                    fetchEmails();
                }, 500);
            }
        } else {
            // Create account folders (will show empty state)
            createAccountFolders();
        }
    } catch (error) {
        console.error('Error loading accounts:', error);
        document.getElementById('accountsList').innerHTML = `
            <div style="color: #e74c3c;">Error loading accounts: ${error.message}</div>
        `;
    }
}

function createAccountFolders() {
    const foldersContainer = document.getElementById('accountFoldersContainer');
    const foldersList = document.getElementById('accountFoldersList');
    
    if (accountsData.length === 0) {
        foldersContainer.style.display = 'none';
        return;
    }
    
    foldersContainer.style.display = 'block';
    
    foldersList.innerHTML = accountsData.map(account => {
        const hasIMAP = account.imap_host && account.imap_host.trim() !== '';
        const hasPOP3 = account.pop3_host && account.pop3_host.trim() !== '';
        const hasIncoming = hasIMAP || hasPOP3;
        
        // Calculate total email count across all folders for this account
        let totalEmailCount = 0;
        if (emailsByAccount[account.id]) {
            Object.values(emailsByAccount[account.id]).forEach(folderEmails => {
                if (Array.isArray(folderEmails)) {
                    totalEmailCount += folderEmails.length;
                }
            });
        }
        
        const isSelected = selectedAccountId == account.id;
        
        return `
            <div class="account-folder ${isSelected ? 'active' : ''}" onclick="selectAccountFolder(${account.id})">
                <div class="account-folder-header">
                    <i class="fas fa-folder account-folder-icon"></i>
                    <div style="flex: 1;">
                        <div class="account-folder-name">${account.name}</div>
                        <div class="account-folder-email">${account.username}</div>
                    </div>
                </div>
                <div class="account-folder-stats">
                    <span>${hasIncoming ? 'âœ“ Configured' : 'âœ— Not Configured'}</span>
                    <span class="account-folder-count">${totalEmailCount} emails</span>
                </div>
            </div>
        `;
    }).join('');
}

function selectAccountFolder(accountId) {
    // Update visual selection
    document.querySelectorAll('.account-folder').forEach(folder => {
        folder.classList.remove('active');
    });
    const folder = document.querySelector(`.account-folder[onclick="selectAccountFolder(${accountId})"]`);
    if (folder) {
        folder.classList.add('active');
    }
    
    // Select the account and auto-fetch
    selectAccount(accountId);
}

function selectAccount(accountId) {
    selectedAccountId = accountId;
    editingAccountId = accountId; // Set for editing
    
    // Update visual selection
    document.querySelectorAll('.account-option').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.id == accountId) {
            el.classList.add('selected');
            el.querySelector('input[type="radio"]').checked = true;
        }
    });
    
    // Load account details into form for editing
    const account = accountsData.find(a => a.id == accountId);
    if (account) {
        // Update current account info display
        document.getElementById('currentAccountInfo').style.display = 'block';
        document.getElementById('currentAccountName').textContent = `${account.name} (${account.username})`;
        
        // Update form title
        document.getElementById('formTitle').innerHTML = `<i class="fas fa-edit"></i> Edit: ${account.name}`;
        
        // SMTP settings
        document.getElementById('accountName').value = account.name || '';
        document.getElementById('smtpHost').value = account.host || '';
        document.getElementById('smtpPort').value = account.port || 465;
        document.getElementById('emailUsername').value = account.username || '';
        document.getElementById('emailPassword').value = ''; // Don't show password for security
        document.getElementById('smtpSSL').checked = account.use_ssl == 1;
        document.getElementById('smtpTLS').checked = account.use_tls == 1;
        
        // Determine which protocol is configured
        const hasIMAP = account.imap_host && account.imap_host.trim() !== '';
        const hasPOP3 = account.pop3_host && account.pop3_host.trim() !== '';
        
        // Load IMAP settings
        document.getElementById('imapHost').value = account.imap_host || '';
        document.getElementById('imapPort').value = account.imap_port || 993;
        document.getElementById('imapSSL').checked = (account.imap_port == 993);
        
        // Load POP3 settings
        document.getElementById('pop3Host').value = account.pop3_host || '';
        document.getElementById('pop3Port').value = account.pop3_port || 995;
        document.getElementById('pop3SSL').checked = (account.pop3_port == 995);
        if (document.getElementById('pop3LeaveOnServer')) {
            document.getElementById('pop3LeaveOnServer').checked = account.pop3_leave_on_server != 0;
        }
        
        // Select the correct protocol radio
        if (account.incoming_protocol === 'pop3' || (hasPOP3 && !hasIMAP)) {
            document.querySelector('input[name="incoming_protocol"][value="pop3"]').checked = true;
            switchProtocol('pop3');
        } else {
            document.querySelector('input[name="incoming_protocol"][value="imap"]').checked = true;
            switchProtocol('imap');
        }
        
        // Show form if neither IMAP nor POP3 is configured
        if (!hasIMAP && !hasPOP3) {
            document.getElementById('accountFormSection').style.display = 'block';
            document.getElementById('toggleFormBtn').innerHTML = '<i class="fas fa-chevron-up"></i> Hide Form';
            showAlert('âš ï¸ Incoming mail not configured! Please enter IMAP or POP3 settings and save.', 'warning');
        } else {
            // AUTO-FETCH: Automatically fetch emails when account is selected
            if (autoFetchEnabled) {
                showAlert(`ðŸ”„ Auto-fetching emails for ${account.name}...`, 'info');
                // Check if we already have emails for this account/folder
                if (emailsByAccount[accountId] && emailsByAccount[accountId][selectedFolder]) {
                    currentEmails = emailsByAccount[accountId][selectedFolder];
                    displayEmails(currentEmails);
                    showAlert(`âœ“ Loaded ${currentEmails.length} emails from cache for ${account.name}`, 'success');
                } else {
                    // Fetch from server
                    fetchEmails();
                }
            }
        }
        
        // Update account folders display
        createAccountFolders();
    }
}

function selectFolder(folder) {
    selectedFolder = folder;
    
    // Update tab visual
    document.querySelectorAll('.folder-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.folder === folder) {
            tab.classList.add('active');
        }
    });
    
    // Check if we have cached emails for this account/folder
    if (selectedAccountId) {
        if (emailsByAccount[selectedAccountId] && emailsByAccount[selectedAccountId][folder]) {
            // Use cached emails
            currentEmails = emailsByAccount[selectedAccountId][folder];
            displayEmails(currentEmails);
            showAlert(`âœ“ Loaded ${currentEmails.length} emails from ${folder}`, 'success');
        } else {
            // Fetch from server
            fetchEmails();
        }
    }
}

// Track if we're editing an existing account
let editingAccountId = null;

// Save email account
document.getElementById('emailAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const protocol = document.querySelector('input[name="incoming_protocol"]:checked').value;
    
    const data = {
        name: document.getElementById('accountName').value,
        host: document.getElementById('smtpHost').value,
        port: document.getElementById('smtpPort').value,
        username: document.getElementById('emailUsername').value,
        password: document.getElementById('emailPassword').value,
        use_ssl: document.getElementById('smtpSSL').checked,
        use_tls: document.getElementById('smtpTLS').checked,
        incoming_protocol: protocol,
        save_to_sent: true
    };
    
    // Add IMAP or POP3 settings based on selected protocol
    if (protocol === 'imap') {
        data.imap_host = document.getElementById('imapHost').value;
        data.imap_port = document.getElementById('imapPort').value;
        data.imap_ssl = document.getElementById('imapSSL').checked;
    } else {
        data.pop3_host = document.getElementById('pop3Host').value;
        data.pop3_port = document.getElementById('pop3Port').value;
        data.pop3_ssl = document.getElementById('pop3SSL').checked;
        data.pop3_leave_on_server = document.getElementById('pop3LeaveOnServer').checked;
    }
    
    if (!data.name || !data.host || !data.username) {
        showAlert('Please fill in account name, SMTP host, and email!', 'error');
        return;
    }
    
    // Validate incoming server settings
    if (protocol === 'imap' && !data.imap_host) {
        showAlert('Please enter IMAP host to enable inbox feature!', 'error');
        return;
    }
    if (protocol === 'pop3' && !data.pop3_host) {
        showAlert('Please enter POP3 host to enable inbox feature!', 'error');
        return;
    }
    
    try {
        let response;
        if (editingAccountId) {
            // Update existing account
            response = await axios.post(`/api/smtp/update/${editingAccountId}`, data);
            if (response.data.success) {
                showAlert('Email account updated successfully!', 'success');
            }
        } else {
            // Add new account
            if (!data.password) {
                showAlert('Password is required for new accounts!', 'error');
                return;
            }
            response = await axios.post('/api/smtp/add', data);
            if (response.data.success) {
                showAlert('Email account added successfully!', 'success');
            }
        }
        
        editingAccountId = null;
        loadAccounts();
        // Hide form
        document.getElementById('accountFormSection').style.display = 'none';
        document.getElementById('toggleFormBtn').innerHTML = '<i class="fas fa-chevron-down"></i> Show Form';
    } catch (error) {
        showAlert('Error saving account: ' + (error.response?.data?.error || error.message), 'error');
    }
});

function clearAccountForm() {
    editingAccountId = null; // Reset editing mode
    document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Email Account';
    document.getElementById('emailAccountForm').reset();
    document.getElementById('smtpPort').value = 465;
    document.getElementById('imapPort').value = 993;
    document.getElementById('pop3Port').value = 995;
    document.getElementById('smtpSSL').checked = true;
    document.getElementById('imapSSL').checked = true;
    document.getElementById('pop3SSL').checked = true;
    document.getElementById('pop3LeaveOnServer').checked = true;
    switchProtocol('imap');
}

function switchProtocol(protocol) {
    const imapSettings = document.getElementById('imapSettings');
    const pop3Settings = document.getElementById('pop3Settings');
    
    if (protocol === 'imap') {
        imapSettings.style.display = 'block';
        pop3Settings.style.display = 'none';
    } else {
        imapSettings.style.display = 'none';
        pop3Settings.style.display = 'block';
    }
}

async function testPOP3Connection() {
    const data = {
        pop3_host: document.getElementById('pop3Host').value,
        pop3_port: document.getElementById('pop3Port').value || 995,
        username: document.getElementById('emailUsername').value,
        password: document.getElementById('emailPassword').value,
        use_ssl: document.getElementById('pop3SSL').checked
    };
    
    if (!data.pop3_host || !data.username || !data.password) {
        showAlert('Please fill in POP3 host, email and password!', 'error');
        return;
    }
    
    try {
        showAlert('Testing POP3 connection...', 'info');
        const response = await axios.post('/api/pop3/test', data, { timeout: 35000 });
        if (response.data.success) {
            showAlert('âœ“ ' + response.data.message, 'success');
        }
    } catch (error) {
        showAlert('âœ— POP3 failed: ' + (error.response?.data?.error || error.message), 'error');
    }
}

async function testSMTPConnection() {
    const data = {
        host: document.getElementById('smtpHost').value,
        port: document.getElementById('smtpPort').value,
        username: document.getElementById('emailUsername').value,
        password: document.getElementById('emailPassword').value,
        use_ssl: document.getElementById('smtpSSL').checked,
        use_tls: document.getElementById('smtpTLS').checked
    };
    
    if (!data.host || !data.username || !data.password) {
        showAlert('Please fill in SMTP host, email and password!', 'error');
        return;
    }
    
    try {
        showAlert('Testing SMTP connection...', 'info');
        const response = await axios.post('/api/smtp/test', data, { timeout: 35000 });
        if (response.data.success) {
            showAlert('âœ“ SMTP connection successful!', 'success');
        }
    } catch (error) {
        showAlert('âœ— SMTP failed: ' + (error.response?.data?.error || error.message), 'error');
    }
}

async function testIMAPConnection() {
    const data = {
        imap_host: document.getElementById('imapHost').value,
        imap_port: document.getElementById('imapPort').value,
        username: document.getElementById('emailUsername').value,
        password: document.getElementById('emailPassword').value,
        use_ssl: document.getElementById('imapSSL').checked
    };
    
    if (!data.imap_host || !data.username || !data.password) {
        showAlert('Please fill in IMAP host, email and password!', 'error');
        return;
    }
    
    try {
        showAlert('Testing IMAP connection...', 'info');
        const response = await axios.post('/api/imap/test', data, { timeout: 35000 });
        if (response.data.success) {
            showAlert('âœ“ ' + response.data.message, 'success');
        }
    } catch (error) {
        showAlert('âœ— IMAP failed: ' + (error.response?.data?.error || error.message), 'error');
    }
}

async function fetchEmails() {
    if (!selectedAccountId) {
        showAlert('Please select an email account first!', 'error');
        return;
    }
    
    // Check if account has IMAP or POP3 configured
    const account = accountsData.find(a => a.id == selectedAccountId);
    const hasIMAP = account && account.imap_host && account.imap_host.trim() !== '';
    const hasPOP3 = account && account.pop3_host && account.pop3_host.trim() !== '';
    
    if (!hasIMAP && !hasPOP3) {
        showAlert('Please configure IMAP or POP3 settings for this account first!', 'error');
        document.getElementById('accountFormSection').style.display = 'block';
        document.getElementById('toggleFormBtn').innerHTML = '<i class="fas fa-chevron-up"></i> Hide Form';
        return;
    }
    
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('emailsList').style.display = 'none';
    
    try {
        // Use appropriate endpoint based on configured protocol
        const protocol = hasPOP3 && !hasIMAP ? 'pop3' : 'imap';
        const endpoint = protocol === 'pop3' 
            ? `/api/inbox/fetch-pop3/${selectedAccountId}?limit=100`
            : `/api/inbox/fetch/${selectedAccountId}?folder=${selectedFolder}&limit=100`;
        
        const response = await axios.get(endpoint, { timeout: 60000 }); // Increased timeout for more emails
        
        if (response.data.success) {
            currentEmails = response.data.emails || [];
            
            // Store emails by account ID for folder organization
            if (!emailsByAccount[selectedAccountId]) {
                emailsByAccount[selectedAccountId] = {};
            }
            emailsByAccount[selectedAccountId][selectedFolder] = currentEmails;
            
            console.log(`Received ${currentEmails.length} emails from server for account ${selectedAccountId}`);
            console.log('Email data:', currentEmails);
            
            if (currentEmails.length === 0 && response.data.total > 0) {
                console.warn('Server says there are emails but none were returned');
            }
            
            displayEmails(currentEmails);
            
            // Update account folders with new email count
            createAccountFolders();
            
            const protocolUsed = protocol.toUpperCase();
            const emailCount = currentEmails.length;
            if (emailCount > 0) {
                showAlert(`âœ“ Fetched ${emailCount} emails from ${selectedFolder} for ${accountsData.find(a => a.id == selectedAccountId)?.name || 'account'}`, 'success');
            } else {
                showAlert(`No emails found in ${selectedFolder} folder`, 'info');
            }
        } else {
            throw new Error(response.data.error || 'Failed to fetch emails');
        }
    } catch (error) {
        console.error('Error fetching emails:', error);
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function sortEmailsByDate(emails, order = 'desc') {
    // Sort emails by date
    const sorted = [...emails].sort((a, b) => {
        const dateA = parseEmailDate(a.date);
        const dateB = parseEmailDate(b.date);
        
        if (order === 'desc') {
            return dateB - dateA; // Newest first
        } else {
            return dateA - dateB; // Oldest first
        }
    });
    return sorted;
}

function parseEmailDate(dateStr) {
    if (!dateStr) return new Date(0); // Return epoch for invalid dates
    
    try {
        // Try parsing as Date object
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
            return date;
        }
        
        // Try parsing RFC822 format
        // This is a simplified parser - for production, use a proper library
        return new Date(dateStr);
    } catch (e) {
        console.warn('Error parsing date:', dateStr, e);
        return new Date(0);
    }
}

function applySorting() {
    const sortSelect = document.getElementById('sortOrder');
    sortOrder = sortSelect.value;
    
    // Re-sort and display current emails
    if (currentEmails && currentEmails.length > 0) {
        currentEmails = sortEmailsByDate(currentEmails, sortOrder);
        displayEmails(currentEmails);
    }
}

function displayEmails(emails) {
    document.getElementById('loadingIndicator').style.display = 'none';
    
    const emailsList = document.getElementById('emailsList');
    
    console.log(`Displaying ${emails.length} emails`);
    
    if (emails.length === 0) {
        emailsList.innerHTML = `
            <div id="noEmailsMessage" class="no-emails-message">
                <i class="fas fa-envelope-open fa-3x"></i>
                <p>No emails found</p>
                <small>Add an email account, select it, and click "Fetch Emails"</small>
            </div>
        `;
        return;
    }
    
    // Sort emails before displaying
    const sortedEmails = sortEmailsByDate(emails, sortOrder);
    
    // Clear any existing content and show list
    emailsList.style.display = 'block';
    emailsList.innerHTML = sortedEmails.map((email, index) => {
        const preview = email.body ? escapeHtml(email.body.substring(0, 80)) : 'Click to view email content';
        return `
        <div class="email-item ${email.unread ? 'unread' : ''}" data-index="${index}" data-uid="${email.uid}" onclick="viewEmail(${index})">
            <div class="email-item-checkbox" onclick="event.stopPropagation();">
                <input type="checkbox" class="email-checkbox" value="${email.uid}" onchange="updateSelectedCount()">
            </div>
            <div class="email-item-content">
                <div class="email-item-from">${escapeHtml(email.from || 'Unknown')}</div>
                <div class="email-item-subject">${escapeHtml(email.subject || '(No Subject)')}</div>
                <div class="email-item-preview">${preview}${email.body && email.body.length > 80 ? '...' : ''}</div>
            </div>
            <div class="email-item-date">${formatDate(email.date)}</div>
            <button class="email-item-delete" onclick="event.stopPropagation(); deleteSingleEmail('${email.uid}')" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    }).join('');
    
    console.log(`Rendered ${emails.length} email items in the list`);
    
    // Show first email in preview by default
    if (emails.length > 0) {
        viewEmail(0);
    }
}

let currentEmailIndex = null;
let emailBodyCache = {}; // Cache loaded email bodies

async function viewEmail(index) {
    const email = currentEmails[index];
    if (!email) return;
    
    currentEmailId = email.uid;
    currentEmailIndex = index;
    
    // Update selection in list
    document.querySelectorAll('.email-item').forEach(item => {
        item.classList.remove('selected');
    });
    const selectedItem = document.querySelector(`.email-item[data-index="${index}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }
    
    // Show preview panel
    document.getElementById('noPreviewMessage').style.display = 'none';
    document.getElementById('emailPreview').style.display = 'flex';
    
    // Update preview content (headers)
    document.getElementById('previewSubject').textContent = email.subject || '(No Subject)';
    document.getElementById('previewFrom').textContent = email.from || 'Unknown';
    document.getElementById('previewTo').textContent = email.to || '';
    document.getElementById('previewDate').textContent = formatFullDate(email.date) || email.date || '';
    
    // Check if body is already loaded or cached
    if (email.html || email.body) {
        // Body already available
        const bodyContent = email.html || email.body || email.text || '(No content)';
        document.getElementById('previewBody').innerHTML = bodyContent;
    } else if (emailBodyCache[email.uid]) {
        // Use cached body
        const cached = emailBodyCache[email.uid];
        document.getElementById('previewBody').innerHTML = cached.html || cached.body || '(No content)';
    } else {
        // Load body on demand
        document.getElementById('previewBody').innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 10px;">Loading email content...</p></div>';
        
        try {
            const account = accountsData.find(a => a.id == selectedAccountId);
            const hasPOP3 = account && account.pop3_host && account.pop3_host.trim() !== '';
            const hasIMAP = account && account.imap_host && account.imap_host.trim() !== '';
            
            // For POP3, body is already in the email object, for IMAP fetch it
            if (hasIMAP && !hasPOP3) {
                const response = await axios.get(`/api/inbox/fetch-body/${selectedAccountId}/${email.uid}?folder=${selectedFolder}`, { timeout: 20000 });
                if (response.data.success) {
                    emailBodyCache[email.uid] = {
                        body: response.data.body,
                        html: response.data.html
                    };
                    const bodyContent = response.data.html || response.data.body || '(No content)';
                    document.getElementById('previewBody').innerHTML = bodyContent;
                } else {
                    document.getElementById('previewBody').innerHTML = '<p style="color: #e74c3c;">Failed to load email content</p>';
                }
            } else {
                // POP3 - body should already be in email object
                document.getElementById('previewBody').innerHTML = email.body || email.html || '(No content)';
            }
        } catch (error) {
            console.error('Error loading email body:', error);
            document.getElementById('previewBody').innerHTML = '<p style="color: #e74c3c;">Error loading email content: ' + (error.message || 'Unknown error') + '</p>';
        }
    }
}

function openInModal() {
    if (currentEmailIndex === null) return;
    
    const email = currentEmails[currentEmailIndex];
    if (!email) return;
    
    document.getElementById('modalSubject').textContent = email.subject || '(No Subject)';
    document.getElementById('modalFrom').textContent = email.from || 'Unknown';
    document.getElementById('modalTo').textContent = email.to || '';
    document.getElementById('modalDate').textContent = formatFullDate(email.date) || email.date || '';
    
    const bodyContent = email.html || email.body || email.text || '(No content)';
    document.getElementById('modalBody').innerHTML = bodyContent;
    
    document.getElementById('emailModal').style.display = 'flex';
}

function deleteCurrentEmail() {
    if (currentEmailId) {
        deleteSingleEmail(currentEmailId);
    }
}

function closeModal() {
    document.getElementById('emailModal').style.display = 'none';
    currentEmailId = null;
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox ? checkbox.checked : true);
    updateSelectedCount();
}

function selectAllEmails() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAllEmails() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.email-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = checked;
    document.getElementById('deleteBtn').disabled = checked === 0;
}

async function deleteSelectedEmails() {
    const checkboxes = document.querySelectorAll('.email-checkbox:checked');
    const uids = Array.from(checkboxes).map(cb => cb.value);
    
    if (uids.length === 0) {
        showAlert('No emails selected!', 'error');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${uids.length} email(s)?`)) {
        return;
    }
    
    try {
        const response = await axios.post('/api/inbox/delete', {
            account_id: selectedAccountId,
            folder: selectedFolder,
            uids: uids
        });
        
        if (response.data.success) {
            showAlert(`${response.data.deleted_count} email(s) deleted!`, 'success');
            fetchEmails();
        }
    } catch (error) {
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
    }
}

async function deleteSingleEmail(uid) {
    if (!confirm('Delete this email?')) return;
    
    try {
        const response = await axios.post('/api/inbox/delete', {
            account_id: selectedAccountId,
            folder: selectedFolder,
            uids: [uid]
        });
        
        if (response.data.success) {
            showAlert('Email deleted!', 'success');
            
            // Clear preview if current email was deleted
            if (currentEmailId === uid) {
                currentEmailId = null;
                currentEmailIndex = null;
                document.getElementById('noPreviewMessage').style.display = 'flex';
                document.getElementById('emailPreview').style.display = 'none';
            }
            
            fetchEmails();
        }
    } catch (error) {
        showAlert('Error: ' + (error.response?.data?.error || error.message), 'error');
    }
}

function deleteEmailFromModal() {
    if (currentEmailId) {
        deleteSingleEmail(currentEmailId);
        closeModal();
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        // Parse the date string (handles various formats including RFC822)
        let date = new Date(dateStr);
        
        // If date string doesn't have timezone info, assume it's UTC
        if (dateStr && !dateStr.includes('+') && !dateStr.includes('Z') && !dateStr.includes('T')) {
            // Try to parse as UTC
            date = new Date(dateStr + ' UTC');
        }
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
            return dateStr;
        }
        
        // ALWAYS use Asia/Kolkata timezone for all date operations
        const now = new Date();
        const nowISTYear = parseInt(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata', year: 'numeric' }));
        const nowISTMonth = parseInt(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata', month: 'numeric' })) - 1;
        const nowISTDay = parseInt(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata', day: 'numeric' }));
        
        // Get IST date components - ALWAYS use Asia/Kolkata
        const istYear = parseInt(date.toLocaleString('en-US', { timeZone: 'Asia/Kolkata', year: 'numeric' }));
        const istMonth = parseInt(date.toLocaleString('en-US', { timeZone: 'Asia/Kolkata', month: 'numeric' })) - 1;
        const istDay = parseInt(date.toLocaleString('en-US', { timeZone: 'Asia/Kolkata', day: 'numeric' }));
        
        const isToday = (istYear === nowISTYear && istMonth === nowISTMonth && istDay === nowISTDay);
        
        // Calculate difference in days using IST
        const nowIST = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
        const dateIST = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
        const diffMs = nowIST - dateIST;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        // Today - show time only with IST
        if (isToday) {
            return date.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }) + ' IST';
        }
        
        // Yesterday
        if (diffDays === 1) {
            return 'Yesterday ' + date.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }) + ' IST';
        }
        
        // This year - show date and time with IST
        if (istYear === nowISTYear) {
            return date.toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }) + ' IST';
        }
        
        // Older - show full date and time with IST
        return date.toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }) + ' IST';
    } catch (error) {
        console.error('Error formatting date:', error, dateStr);
        return dateStr;
    }
}

function formatFullDate(dateStr) {
    if (!dateStr) return '';
    try {
        // Ensure we always parse as UTC if it's a database timestamp
        let date = new Date(dateStr);
        
        // If date string doesn't have timezone info, assume it's UTC
        if (dateStr && !dateStr.includes('+') && !dateStr.includes('Z') && !dateStr.includes('T')) {
            // Try to parse as UTC
            date = new Date(dateStr + ' UTC');
        }
        
        if (isNaN(date.getTime())) {
            return dateStr;
        }
        
        // Format full date in IST (Kolkata timezone) - ALWAYS use Asia/Kolkata
        const formatted = date.toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
        return formatted + ' IST';
    } catch (error) {
        console.error('Error formatting full date:', error, dateStr);
        return dateStr;
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});

// Close modal on outside click
document.getElementById('emailModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// Hot Leads and Follow-ups Functions
function showHotLeads() {
    document.getElementById('hotLeadsSection').style.display = 'block';
    document.getElementById('followUpsSection').style.display = 'none';
    loadHotLeads();
}

function showFollowUps() {
    document.getElementById('followUpsSection').style.display = 'block';
    document.getElementById('hotLeadsSection').style.display = 'none';
    loadFollowUps();
}

function loadHotLeads() {
    axios.get('/api/inbox/responses?hot_leads_only=true')
        .then(response => {
            if (response.data.success) {
                const responses = response.data.responses;
                document.getElementById('hotLeadsCount').textContent = responses.length;
                
                if (responses.length === 0) {
                    document.getElementById('hotLeadsList').innerHTML = '<p>No hot leads found.</p>';
                    return;
                }
                
                const html = responses.map(response => {
                    return `
                        <div style="border: 1px solid #27ae60; border-radius: 5px; padding: 15px; margin-bottom: 10px; background: #d5f4e6;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; color: #27ae60;">
                                        <i class="fas fa-fire"></i> ${escapeHtml(response.recipient_email || 'Unknown')}
                                    </h4>
                                    <p style="margin: 5px 0; color: #2c3e50;"><strong>Subject:</strong> ${escapeHtml(response.subject || 'No subject')}</p>
                                    <p style="margin: 5px 0; color: #7f8c8d; font-size: 12px;">
                                        <strong>Original:</strong> ${escapeHtml(response.original_subject || 'N/A')}
                                    </p>
                                    <p style="margin: 5px 0; color: #7f8c8d; font-size: 12px;">
                                        <strong>Date:</strong> ${formatDate(response.created_at)}
                                    </p>
                                    ${response.response_content ? `
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 3px; max-height: 200px; overflow-y: auto;">
                                            <strong>Response:</strong>
                                            <p style="white-space: pre-wrap; margin-top: 5px;">${escapeHtml(response.response_content.substring(0, 500))}${response.response_content.length > 500 ? '...' : ''}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('hotLeadsList').innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading hot leads:', error);
            document.getElementById('hotLeadsList').innerHTML = '<p style="color: #e74c3c;">Error loading hot leads</p>';
        });
}

function loadFollowUps() {
    axios.get('/api/inbox/follow-ups')
        .then(response => {
            if (response.data.success) {
                const followUps = response.data.follow_ups;
                document.getElementById('followUpsCount').textContent = followUps.length;
                
                if (followUps.length === 0) {
                    document.getElementById('followUpsList').innerHTML = '<p>No follow-ups needed at this time.</p>';
                    return;
                }
                
                const html = followUps.map(followUp => {
                    const daysSince = followUp.days_since_sent || 0;
                    return `
                        <div style="border: 1px solid #f39c12; border-radius: 5px; padding: 15px; margin-bottom: 10px; background: #fef5e7;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; color: #f39c12;">
                                        <i class="fas fa-clock"></i> ${escapeHtml(followUp.recipient_email || 'Unknown')}
                                    </h4>
                                    <p style="margin: 5px 0; color: #2c3e50;">
                                        <strong>Name:</strong> ${escapeHtml((followUp.name || 'N/A'))}
                                    </p>
                                    <p style="margin: 5px 0; color: #2c3e50;">
                                        <strong>Company:</strong> ${escapeHtml(followUp.company || 'N/A')}
                                    </p>
                                    <p style="margin: 5px 0; color: #2c3e50;">
                                        <strong>Subject:</strong> ${escapeHtml(followUp.subject || 'No subject')}
                                    </p>
                                    <p style="margin: 5px 0; color: #7f8c8d; font-size: 12px;">
                                        <strong>Sent:</strong> ${formatDate(followUp.sent_at)} (${daysSince} days ago)
                                    </p>
                                    ${followUp.follow_up_date ? `
                                        <p style="margin: 5px 0; color: #7f8c8d; font-size: 12px;">
                                            <strong>Follow-up Date:</strong> ${formatDate(followUp.follow_up_date)}
                                        </p>
                                    ` : ''}
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="createFollowUpCampaign('${escapeHtml(followUp.recipient_email)}', '${escapeHtml(followUp.subject)}')">
                                    <i class="fas fa-envelope"></i> Create Follow-up
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('followUpsList').innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading follow-ups:', error);
            document.getElementById('followUpsList').innerHTML = '<p style="color: #e74c3c;">Error loading follow-ups</p>';
        });
}

function monitorInbox() {
    const accountSelect = document.getElementById('accountSelect');
    if (!accountSelect || !accountSelect.value) {
        showAlert('Please select an email account first', 'error');
        return;
    }
    
    showAlert('Monitoring inbox...', 'info');
    
    axios.post(`/api/inbox/monitor/${accountSelect.value}`)
        .then(response => {
            if (response.data.success) {
                const result = response.data.result;
                showAlert(`Found ${result.responses_found} responses and ${result.follow_ups_needed} follow-ups needed`, 'success');
                loadHotLeads();
                loadFollowUps();
            }
        })
        .catch(error => {
            showAlert('Error monitoring inbox: ' + (error.response?.data?.error || error.message), 'error');
        });
}

function createFollowUpCampaign(email, originalSubject) {
    // Redirect to campaign builder with pre-filled data
    window.location.href = `/campaign-builder?followup=1&email=${encodeURIComponent(email)}&subject=${encodeURIComponent('Re: ' + originalSubject)}`;
}

// Load counts on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load hot leads count
    axios.get('/api/inbox/responses?hot_leads_only=true')
        .then(response => {
            if (response.data.success) {
                document.getElementById('hotLeadsCount').textContent = response.data.count;
            }
        })
        .catch(error => console.error('Error loading hot leads count:', error));
    
    // Load follow-ups count
    axios.get('/api/inbox/follow-ups')
        .then(response => {
            if (response.data.success) {
                document.getElementById('followUpsCount').textContent = response.data.count;
            }
        })
        .catch(error => console.error('Error loading follow-ups count:', error));
});
</script>
{% endblock %}
