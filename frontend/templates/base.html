<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANAGHA SOLUTION - {% block title %}Bulk Email Software{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ANAGHA SOLUTION</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item {% if request.endpoint == 'index' %}active{% endif %}">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="/campaign-builder" class="nav-item {% if request.endpoint == 'campaign_builder' %}active{% endif %}">
                    <i class="fas fa-envelope"></i> Campaign Builder
                </a>
                <a href="/recipients" class="nav-item {% if request.endpoint == 'recipients' %}active{% endif %}">
                    <i class="fas fa-users"></i> Recipients
                </a>
                <a href="/leads" class="nav-item {% if request.endpoint == 'leads' %}active{% endif %}">
                    <i class="fas fa-user-tie"></i> Leads
                </a>
                <a href="/smtp-config" class="nav-item {% if request.endpoint == 'smtp_config' %}active{% endif %}">
                    <i class="fas fa-cog"></i> SMTP Config
                </a>
                <a href="/inbox" class="nav-item {% if request.endpoint == 'inbox' %}active{% endif %}">
                    <i class="fas fa-inbox"></i> Inbox
                </a>
                <a href="/templates" class="nav-item {% if request.endpoint == 'templates' %}active{% endif %}">
                    <i class="fas fa-file-alt"></i> Templates
                </a>
                <a href="/analytics" class="nav-item {% if request.endpoint == 'analytics' %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i> Analytics
                </a>
                <a href="/sent-items" class="nav-item {% if request.endpoint == 'sent_items_page' %}active{% endif %}">
                    <i class="fas fa-paper-plane"></i> Sent Items
                </a>
                <a href="/settings" class="nav-item {% if request.endpoint == 'settings_page' %}active{% endif %}">
                    <i class="fas fa-sliders-h"></i> Settings
                </a>
            </nav>
            <div class="sidebar-footer" style="padding: 20px; border-top: 1px solid #e0e0e0; margin-top: auto;">
                <div style="font-size: 12px; color: #7f8c8d;">
                    <a href="/terms" style="color: #7f8c8d; text-decoration: none; display: block; margin-bottom: 5px;">Terms</a>
                    <a href="/privacy" style="color: #7f8c8d; text-decoration: none; display: block; margin-bottom: 5px;">Privacy</a>
                    <a href="/gdpr" style="color: #7f8c8d; text-decoration: none; display: block;">GDPR</a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <script>
    // CRITICAL: Set token in axios IMMEDIATELY after axios loads, before auth.js
    (function() {
        const token = localStorage.getItem('jwt_token') || sessionStorage.getItem('jwt_token');
        if (token && typeof axios !== 'undefined') {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            console.log('Token set in axios before auth.js loads');
        }
    })();
    </script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/session.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    // Global session management - non-blocking, prevents redirect loops
    (async function() {
        // Wait for scripts to load
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Initialize auth - ensure token is set in axios
        let token = localStorage.getItem('jwt_token') || sessionStorage.getItem('jwt_token');
        if (token && typeof axios !== 'undefined') {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        }
        
        // Initialize AuthManager
        if (typeof AuthManager !== 'undefined') {
            AuthManager.init();
        }
        
        // List of public pages that don't require auth
        const publicPages = ['/login', '/register', '/terms', '/privacy', '/gdpr', '/health'];
        const currentPath = window.location.pathname;
        const isPublicPage = publicPages.includes(currentPath);
        
        // For protected pages, validate token in background (non-blocking)
        // Only redirect if we're sure the token is invalid
        if (!isPublicPage) {
            // Get token from storage directly
            token = localStorage.getItem('jwt_token') || sessionStorage.getItem('jwt_token');
            
            if (token) {
                // Set header immediately
                if (typeof axios !== 'undefined') {
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                }
                
                // Validate token
                if (typeof AuthManager !== 'undefined') {
                    AuthManager.validateToken().then(isValid => {
                        if (!isValid) {
                            // Token invalid - redirect to login
                            console.log('Token validation failed, redirecting to login');
                            if (window.location.pathname !== '/login') {
                                window.location.href = '/login';
                            }
                        }
                    }).catch(() => {
                        // Silent fail - let API calls handle auth errors via 401
                    });
                }
            } else {
                // No token at all - redirect to login
                console.log('No token found, redirecting to login');
                if (window.location.pathname !== '/login' && window.location.pathname !== '/register') {
                    window.location.href = '/login';
                }
            }
        }
    })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>

