{% extends "base.html" %}

{% block title %}Sent Items - ANAGHA SOLUTION{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-paper-plane"></i> Sent Items</h1>
    <p>View all emails sent through ANAGHA SOLUTION</p>
</div>

<div class="table-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div style="flex: 1; margin-right: 15px;">
            <input type="text" id="searchInput" placeholder="Search by recipient, subject, or sender..." 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                   onkeyup="searchSentEmails()">
        </div>
        <button class="btn btn-primary" onclick="refreshSentEmails()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
    
    <table id="sentEmailsTable">
        <thead>
            <tr>
                <th>Date & Time</th>
                <th>To</th>
                <th>Subject</th>
                <th>Campaign</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="sentEmailsTableBody">
            <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: #7f8c8d;">
                    Loading sent emails...
                </td>
            </tr>
        </tbody>
    </table>
    
    <div id="pagination" style="margin-top: 15px; text-align: center;"></div>
</div>

<!-- Email View Modal -->
<div id="emailModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div style="background: white; margin: 50px auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="modalSubject">Email Details</h2>
            <button onclick="closeEmailModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 0;
let pageSize = 50;
let currentSearch = '';

async function loadSentEmails(page = 0) {
    try {
        const offset = page * pageSize;
        const url = `/api/sent-emails?limit=${pageSize}&offset=${offset}${currentSearch ? '&search=' + encodeURIComponent(currentSearch) : ''}`;
        const response = await axios.get(url);
        
        if (response.data.success) {
            displaySentEmails(response.data.sent_emails);
            updatePagination(response.data.total, page);
        }
    } catch (error) {
        showAlert('Error loading sent emails: ' + (error.response?.data?.error || error.message), 'error');
    }
}

function displaySentEmails(emails) {
    const tbody = document.getElementById('sentEmailsTableBody');
    
    if (emails.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #7f8c8d;">No sent emails found.</td></tr>';
        return;
    }
    
    tbody.innerHTML = emails.map(email => {
        const sentDate = email.sent_at ? new Date(email.sent_at).toLocaleString() : '-';
        const recipientName = email.recipient_name || email.recipient_email;
        const campaignName = email.campaign_name || 'N/A';
        
        return `
            <tr>
                <td>${sentDate}</td>
                <td>${recipientName}</td>
                <td>${email.subject || '-'}</td>
                <td>${campaignName}</td>
                <td>
                    <span class="status-badge sent">Sent</span>
                </td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewEmail(${email.id})">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination(total, page) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '<div style="display: flex; justify-content: center; gap: 5px;">';
    
    if (page > 0) {
        html += `<button class="btn btn-sm" onclick="loadSentEmails(${page - 1})">Previous</button>`;
    }
    
    for (let i = Math.max(0, page - 2); i < Math.min(totalPages, page + 3); i++) {
        html += `<button class="btn btn-sm ${i === page ? 'btn-primary' : ''}" onclick="loadSentEmails(${i})">${i + 1}</button>`;
    }
    
    if (page < totalPages - 1) {
        html += `<button class="btn btn-sm" onclick="loadSentEmails(${page + 1})">Next</button>`;
    }
    
    html += '</div>';
    pagination.innerHTML = html;
}

function searchSentEmails() {
    currentSearch = document.getElementById('searchInput').value;
    currentPage = 0;
    loadSentEmails(0);
}

function refreshSentEmails() {
    loadSentEmails(currentPage);
}

async function viewEmail(emailId) {
    try {
        const response = await axios.get(`/api/sent-emails/${emailId}`);
        if (response.data.success) {
            const email = response.data.email;
            document.getElementById('modalSubject').textContent = email.subject || 'Email Details';
            
            const content = `
                <div style="margin-bottom: 15px;">
                    <strong>To:</strong> ${email.recipient_email}<br>
                    <strong>From:</strong> ${email.sender_name} &lt;${email.sender_email}&gt;<br>
                    <strong>Date:</strong> ${email.sent_at ? new Date(email.sent_at).toLocaleString() : '-'}<br>
                    <strong>Campaign:</strong> ${email.campaign_name || 'N/A'}<br>
                    <strong>Subject:</strong> ${email.subject || '-'}
                </div>
                <hr>
                <div style="margin-top: 20px;">
                    ${email.html_content || email.text_content || 'No content'}
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('emailModal').style.display = 'block';
        }
    } catch (error) {
        showAlert('Error loading email: ' + (error.response?.data?.error || error.message), 'error');
    }
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
}

// Load on page load
loadSentEmails(0);
</script>
{% endblock %}
